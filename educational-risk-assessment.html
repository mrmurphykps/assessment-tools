<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive risk assessment tool for educational activities, trips, and events">
    <meta name="theme-color" content="#d61b26">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Risk Assessment">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <title>Educational Risk Assessment Tool</title>   
 <style>
.home-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #d61b26;
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: all 0.2s;
}
.home-button:hover {
    background: #b71620;
    transform: scale(1.1);
}
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #d0caca 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 40px;
        }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .school-logo { height: 80px; width: auto; object-fit: contain; }
        h1 { color: #1f2937; font-size: 28px; }
        h2 { color: #1f2937; font-size: 20px; margin: 30px 0 15px 0; }
        h3 { color: #374151; font-size: 16px; margin: 25px 0 15px 0; font-weight: 600; }
        .meta { color: #6b7280; font-size: 14px; margin: 8px 0; font-weight: 500; }
        .draft-status {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .draft-status-info { display: flex; align-items: center; gap: 10px; color: #92400e; font-size: 14px; font-weight: 500; }
        .draft-status.hidden { display: none; }
        .upload-section {
            background: #f0f9ff;
            border: 2px dashed #0ea5e9;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section h2 { color: #0c4a6e; font-size: 18px; margin-bottom: 12px; }
        .upload-section p { color: #075985; font-size: 14px; margin-bottom: 20px; }
        .upload-btn-wrapper { position: relative; display: inline-block; }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .upload-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #0ea5e9;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .upload-btn:hover { background: #0284c7; }
        .divider { text-align: center; margin: 30px 0; position: relative; }
        .divider:before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }
        .divider span { background: white; padding: 0 15px; position: relative; color: #6b7280; font-size: 14px; font-weight: 500; }
        .progress-container { margin-bottom: 40px; }
        .progress-labels { display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; }
        .progress-label { font-size: 11px; color: #6b7280; text-align: center; flex: 1; min-width: 80px; }
        .progress-label.active { color: #d61b26; font-weight: 600; }
        .progress-bar { height: 8px; background: #d0caca; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #d61b26; transition: width 0.3s ease; }
        .step-content { margin-bottom: 40px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        input[type="text"], input[type="tel"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #d61b26; box-shadow: 0 0 0 3px rgba(214, 27, 38, 0.1); }
        textarea { resize: vertical; min-height: 92px; }
        .checkbox-group { display: flex; align-items: flex-start; gap: 10px; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin-top: 3px; cursor: pointer; }
        .checkbox-group label { margin-bottom: 0; font-weight: 400; }
        .checkbox { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
        .checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
        .info-box { background: #fafafa; border: 1px solid #a59a9e; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .info-box h3 { color: #d61b26; font-size: 16px; margin-bottom: 8px; }
        .info-box p { color: #6e605d; font-size: 13px; line-height: 1.5; margin-bottom: 8px; }
        .info-box p:last-child { margin-bottom: 0; }
        .info-box.green { background: #d1fae5; border-color: #6ee7b7; }
        .info-box.green h3 { color: #065f46; }
        .info-box.green p { color: #047857; }
        .info-box.gray { background: #f3f4f6; border-color: #a59a9e; }
        .info-box.gray p { color: #6e605d; }
        .risk-list { margin-top: 20px; }
        .risk-card, .action-card { 
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 16px; 
        }
        .risk-header, .action-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .risk-header h4, .action-header h4 { color: #374151; font-size: 16px; font-weight: 600; margin: 0; }
        .empty-state { text-align: center; padding: 60px 20px; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 8px; }
        .empty-state p { color: #6b7280; margin-bottom: 20px; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; }
        .row > div { flex: 1 1 240px; min-width: 240px; }
        .activity-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .activity-table th { background-color: #f3f4f6; padding: 12px; text-align: left; border: 1px solid #d1d5db; font-weight: 600; color: #374151; font-size: 14px; }
        .activity-table td { padding: 12px; border: 1px solid #d1d5db; vertical-align: middle; }
        .activity-table td:first-child { font-weight: 500; color: #374151; width: 35%; }
        .activity-table td:nth-child(2) { width: 50%; }
        .activity-table td:last-child { width: 15%; text-align: center; }
        .activity-table textarea { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        .na-checkbox { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; color: #6b7280; }
        .activity-table tbody tr:hover { background-color: #f9fafb; }
        .summary-grid { display: grid; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #6ee7b7; }
        .summary-item { color: #047857; font-size: 14px; }
        button { padding: 10px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn, .btn-primary { background: #d61b26; color: white; border: 1px solid #d61b26; }
        .btn-primary:hover { background: #b01620; }
        .btn-secondary { background: white; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; }
        .btn-danger:hover { background: #fecaca; }
        .btn-ghost { background: transparent; border: 1px solid #d1d5db; color: #6b7280; }
        .btn-ghost:hover { background: #f9fafb; }
        .btn-dashed { width: 100%; padding: 14px; background: white; color: #6b7280; border: 2px dashed #d1d5db; }
        .btn-dashed:hover { border-color: #d61b26; color: #d61b26; background: #fef2f2; }
        .btn-large { width: 100%; padding: 16px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .type-selection-btn:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(214, 27, 38, 0.15); }
        .navigation { display: flex; justify-content: space-between; padding-top: 30px; border-top: 1px solid #e5e7eb; gap: 12px; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 30px; }
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; text-align: center; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            .grid-2 { grid-template-columns: 1fr; }
            .navigation { flex-direction: column; }
            .row > div { min-width: 100%; }
        }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; padding: 20px; }
            .navigation, .progress-container, .draft-status, .upload-section, button { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
<img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAB4AMgDASIAAhEBAxEB/8QAHAABAAIDAQEBAAAAAAAAAAAAAAUGAwQHAgEI/8QARhAAAQMDAwEFBQUBCw0AAAAAAQIDBAAFEQYSITETFEFRYQciMnGBFSMkkaFSFhc1QkNic7Gy0vAlJzM0cnR1goOSorPB/8QAGgEBAAMBAQEAAAAAAAAAAAAAAAECAwUEBv/EAC0RAAICAQIEBAYCAwAAAAAAAAABAhEDEiEEMUFRYXGBkQUTIjKxwaHwFDSy/9oADAMBAAIRAxEAPwDv9KUoBSlKAUpSgFKUoBSlKAVWtWy9QxowVZWR2aElbrgSla8AEnAUQB09c56cVZahLwt1yYlhIzsjrfbQQcLcT8OT0wDjg+Khx5Aip6C1I63FuiLy+VSEPIWpCUqWtK3AcN/zlYT0T0+hqypmSby2lYQ9HYdOxpvgEnHxLIPgAfdHHmT0HHtE6iagSHEXSI49HW+qQ68lory6pOwbyM4SNyzkZOTXRUXh6Rc2HbZPgSLetk94lh5Ke7AKGSsnkqI4GcZ56YNCzRemWUsMpaRnakYGTk/nWSovTtwcullZmL3FLil9mtSdpcbCyELI8NyQD9alKFRSlKAUpSgFKUoBSlKAUpSgFKUoBSlKAUpSgFKUoBSlKA+KUEpKlEAAZJPhVM1XrHT0S19oZTciUFfhkNLOQsY5JHRI4J88dDXzVOrzFurunGrNLnPPxt34ZY3bVAg4GPDFcdgNOzpkp7uUya+wN5QhAw2kdSoeGKxlmSdI7XBfBsmaDy5No1aqrd8uu3mzoLLkPROmm123UEd9bbgelsJb5krUOiFAEpwMYByOOcZr5cplmv0Rp5bkCbcFupEc9ltWSXB7q/BSMZ3FXGOmDVYl2ZudphOp3ZTv2ehzsu6hIC92dud2cYz6ZxUZc3Hmm4cWRBmQ2HgFlvaElxs9NmaPOlbN8XwSWRRjGX1W1LlUa5ru35bePU/SCUhKQlIASOAAOgr7VO0/rZVzvwsciyy4D6GC5+IWM4GMcYzznrVxrSMlJWji8Rw+Th5aMip8+nL0FKUqxgKUpQClKUApSlAKUpQClKUApSlAKUpQClKUApSlAck1vqOVYNeuBhDC25ERlKw9kBOCrCsjkYyfpS8T5ul4S7kiTCluTHQp1pxJSnfjA7LaclGBzu8hznNSet3NEo1CE3+LNcnFlJBZ342ZOOhHrVcD/stPAgXPj1c/vV5JWm90fZcLonhxP5U3srqKal62bIuEg+x9Vx3DvP2n227HG7tc9PnWezz5uqoaLiqRCiLhulTTTaSoFeMfe7jkIwrjbzyec4qaDujf3uSvu8v7C7x/o8q3793zzjPrVVMj2XDgwLmMjzc/vVD2rdcu4xyjkjkSxSvXKmop0nWzVkhorUcq/wCvWkvoYQ3HivJR2OSFZKcqyeTnA+ldbrm+iXNEq1CU2CLNanBlZJe342cZ6k+ldIrfD9u7s4fxlxfEJQg4pJbNU+vmKUpWpyRSlKAUpSgFKUoBSlKAUpSgFKUoBSlKAUpSgFa1wuES1QHps59LMZkbluK6AVs1G6gs7V+sMy2OnamQ2UhX7KuqT9CAaApOor1b0PwNZW5kXCKtBiKeb91bCwokEbhxnKknOPD6xrjjml++X160RwiVgLRHcAcYyMbVKIwsKOCdvqeetR2nLlG09LmadvERX2c8OzntKClJYdOQFZ8QQASR0ACs1h1hoy+w2Euwpkq7WUALZw4XC0nwynxGDwoeHlXnyxcfqR9N8KzYcyjgytJ8nd/VHmlz2a/vVOT78wfZOqeILIY+1O07pj7vb2vw/LH+PCvbTjmqhDvbNpjFEQkNtyXApx/AxsSoDCAk5I3eh461Hgf5jFDx790/6lYNH6LvsxlT0yXKtNmI3vZcLZdT44T4DA+I/rWVttJdkdFwwwx5cspKLjOSTd8trSV7t+/5Vq09e4LkifrG4sC3xWkdzDzvvLfWVDJ90c4wlIxnx+l+t9xiXWA1OgvpejPDKHE9D4VyHUNxi3+RCsNlioXbWPuokcbgHnCCN/HIAGcE9ffJI4rqunrO1YLDDtjR3BhGFK/aUeVH6kmvXCOlUz5LjM0c2VyiqXJLskSdKUqx5RSlKAUpSgFKUoBSlKAUpSgFKUoBSlKAUpSgFKUoCs6q0dG1EgPtLEe4ITtQ7glKx+ysAjI5PPUZOPEVz9lOq9F9skJkMNF1SwEI7eLtJAAAA93HJPwniuzUoSmcbV7Trn3Re2Hag6lZVsW0QSoK6gBZycZNfFjVetHG0rTIdjbjlKk9jHIzwSfHggj4iCOldj7NG7dsTu88c16oTqK1pjSDFhJlyHRLuTidq3ynASOMpQPAcDJ6nHyAstKUKilKUApSlAKUpQClKZoBSlKAo1smMWvVWqFuB1wNPR2orCVFRKlt5KEJJwCTz5eJwBU9a7O6Jbl0uat894g9khZLTAAwEpHQnzVjk+Q4qpKsj111hqeVb5HdrrBfjuRXc+7ks4KFDxSocGrXpvUjd7adjyGjEukU7ZURfxIPmPNJ8DWMHvT8Ts8ZGShrxO/pjq7r6V/D6vvs/GcWkLQUqGUkYI86qWgE5gXRalLWpNyfaSVrKiEJICUjJ6CrdVS9n/8ABt2/4tJ/tCrv70ePD/q5fOP7LHclbbXLUPBlZ/8AE1T9IagmQhAst/Xl2RHQ7AmH4ZCCkHYT+2M49f67fc/4Kmf0C/7JqBjWSHqPQFqiSwcGEwtt1PC2lhAwpJ8CKiSerYvw0sSwOOVbNrfqtnuv2uvsZdXMpWLQv3gTcmG1FKincgqOUnHUHyqwOutxo63XCEttpKlHyAGTXPV3ae1It2nr9zcmLhHWxJA92Y0F/EP5w8RV9uEXvttlRN23t2Vt58tySP8A7SLu2hxOJ4o44Te2+65NbbogLJHOprei8XXetuVlceJvIbaaz7uQPiURySc9cDFbT2lLel9iRASuE+08hzLDqkJWkKBKVJBwQRkdK0PZ/cUu6fbtL/3Vxtn4aQwr4k7ThJx5EY5r3rF6THlWHu0uQwJNyajPBpwgKbIJI/Tr1qFWi2bTWZcXLDGWlW67V08017lpOcHHWqNpuNbdUWR3v6lLvSFLRMUpag8w7uOMc+6kcYA44+dXda0MMqccVtQhJKlHwA8apetLMiE05qy1Od1ukNIcWpPCZCBjKVjx4/x0xM+5jwLTbxW4yk1T8ez8Hf4LjIjNSoymH07kKGDyR+o6VV9ALcatc63SXFuS4E11hxbiipSxnKVEn0P6Va2lFxpC1JKSpIJSfD0qiXd9+x6zntRcpcvsNCY5HhJSoIz9Eq3H5Uns1IcJF5YT4fq6a809/wCG36G3Zr7Kf1tKafX/AJPntKVb+cj7lRQvH+1yr5YqQmR03LWsVr3uygxS88EqIC1LVtbSoDrgJWefStHVkBNosdruUJBzY3W1pA6lnhCx/wBpz9KldNYltTLvwRcJBcbVj+RT7jf5hO7/AJqhXel/3+s2yuCh/k41SrT68v8AnfzGpru9bIkZiHs7/PkJixysZCFK6rI8QkZP5VkRpm2lrEppUx4j335Kytaj558PkMAVC6/Q7FRZ74hCnGrXNS6+lIyQ2eFH6cfnVuYfakx232HEuNOJCkLSchQPQipW8mmYSvFw+OeN1d213XT2p+pUkSZOl9WwrUuQ7ItNzChG7dZWuO6nnaFHkpIxjPSpvUl6FhsT84Nhx0YQy2f47ijhI+WTz6ZqHvzP2rrawQ2feMBS5slQ/k04wgH1Uc8eQNZPaFBkzNJuuRUFx6I63KCB1UEHJH5ZP0qLaUqN1DHlzYPmc5Vq92lfmqv36m/G05HWwld1JuExQy668SU58QhPRKfIAfPJqGuTj2jLvbno7zq7LNfEZ6O6srEdavhWgnJA65HSrTbLlGu1tjz4jgWw+gLSQenofUdKrmtmftVyz2Rn3pD81D6wP4jLeSpZ8hyB6k0kko3Epw2ScuI+Xm+3e10W3bpXTsWtxtDzam3EhSFcEHxqj6HtEO6aaD81LrzxkPI3qfc3YSsgDO7wAq9eFVL2cEfuST/vUj/2GpkrmvX9GeCcocLkcXW8fxI1rs7N0RMizm5kiVYnnksyY8lwuKj7ui0LPOPQk/rwrb1839pWdmxM4VLuMhtCEjqlCVBS1n0AHX1FKzk5xlUOR0uGxcDnwxycbLTLfl1Xd7eavwJmFYoUC5SZ8fthIlEF9SnlKDhAwMgnHA6YpO0/brhPZnusqRNZGESGXFNrA8iUkZHoc1J0rfSuRw/n5dWvU75c+nY8bPuuz3K6Y3Z5+efOtC02KFZEupgpdQh5ZcWlTqlgrPVXJPJxUlSlIqsklFxT2fMwyoyJkZyO4VhtxJSrYopJB68isdut7FrhNw428MNJCW0rWVbUjgAE84rapSupGuWnRexqTLbDuC4y5LCXFxnQ8yo9ULHiDW3SlSQ5NpJvZEVcdO2y5ykS3mFImIGESWHFNOgeW5JBI9DWJvTEHvTEiS9MmOR1hxnvUlSw2odFAdM+pqarytYbbUtXwpBJqNK7Gy4nMo6VJ15nx5luQw4w6nc24koWk+IIwRUQxpiC0lptbsuRHZKVNMSJCnG0lPw8HrjAxnOKxxdW22SI6iiYw1JKQy8/EcbbWVfCAojHOeM9azStRxItwehCPOfeZCS53eItwJ3DIyUjyo0mUhlyQVRdExWrIt0WVNiTHmgp+IVFlWfhKhg/pWovUVuTZxdEOOOxy4GgG2lFe8q2bdmMhW7jGM17g3pudI7FMK4MnaVbpERbafzIxmpKxlKLtG7KjNTIj0V9O9l5Cm1p80kYIpGjtRIrMZhO1plAbQnySBgCoVGsLWpParTMbjbyjvTkRwMghW3leMAZGMnip+g1SrT0Pi0JcQpC0hSVDBBGQRUGzpSBDKhAemwmVEksRpKkt5PXCeifpip2lQ0nzLQyzgmoukzVg26Jbm1IitBG9W5aiSpS1ealHlR9Sa2qUqeRSUnJ3J2yE/ctb2pLj8JUmAp1W5xMR9TaFnzKPhz64reg2qJb1OOMtqLzuO0ecWVuLx0yo5OPToK3aVCikaSz5ZqpSbPLiO0bUjcpORjKTgj5GoOHpG321pTVvenxWlKKihuWvaSepwSeanqUaT5kQzZIJxi6TNGDZ4VvecfZbUqQ4AFvurU44oeRUok49OlK3qVKVFZTlN3J2xSlKFRSlKAUpSgFKUoBWGX/AKm//Rq/qpSgKhZbVdbtpSzxZkuGi2mPHcKGWVdqtKQlQSVFWB0GSB8sVkWi8q1NqFdofhocS2wQ3JZUsLV2ZwNwUNo+hpShJoylRk6ETIRMcacXcmXZb76UhbL3bp37k/CNp8OmAOvWp2x3KLImqZRqlm6uKRlLKQ0CMHlXuDNKUJIeyW273XSvce+RGLdIU+2spZUp7sy4sKAJVtBPIzjjPSrwhAbQlCRhKRgfKlKEM9UpShApSlAKUpQClKUApSlAf//Z" alt="Kingswood Prep Logo" class="school-logo">
            <div>
                <h1>KPS H&S and Trips Tool</h1>
                <p class="meta">Version: 2.0</p>
            </div>
        </div>

        <div class="draft-status hidden" id="draftStatus">
            <div class="draft-status-info">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="draftStatusText">Draft loaded</span>
            </div>
            <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="clearDraft()">
                Start New
            </button>
        </div>

        <div class="progress-container">
            <div class="progress-labels" id="progressLabels"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="step-content" id="stepContent"></div>

        <div class="navigation">
            <button class="btn-secondary" id="prevBtn" onclick="previousStep()">
                ‚Üê Previous
            </button>
            <button class="btn-warning" id="saveDraftBtn" onclick="saveDraft()" style="display: none;">
                üíæ Save Draft
            </button>
            <button class="btn-primary" id="nextBtn" onclick="nextStep()">
                Next ‚Üí
            </button>
        </div>

        <div class="divider"><span>OR</span></div>

        <div id="uploadSection" class="upload-section">
            <h2>üìÇ Resume Previous Draft</h2>
            <p>Upload a previously saved draft to continue where you left off</p>
            <div class="upload-btn-wrapper">
                <div class="upload-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Choose Draft File
                </div>
                <input type="file" accept=".json" onchange="loadDraft(event)" />
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 12px;">Accepts .json files only</p>
        </div>
    </div>

    <script>
        const FORM_VERSION = '2.0';
        
        const assessmentTypes = [
            { value: 'allergy', label: 'Allergy Risk Assessment' },
            { value: 'pre_booking', label: 'Pre-Booking Trip Approval' },
            { value: 'school_trip', label: 'School Trip / Off-site Visit' },
            { value: 'onsite_event', label: 'On-site Event' },
            { value: 'curriculum_activity', label: 'Curriculum Activity' },
            { value: 'temporary_disability', label: 'Temporary Disability' },
            { value: 'peep', label: 'Personal Emergency Evacuation Plan (PEEP)' }
        ];

        const categories = [
            {
                id: 'person',
                title: 'Person Risks',
                description: 'Risks directly related to occurrence/event/activity',
                examples: 'E.g., safeguarding, medical needs, injuries, lost child, Personal Protective Equipment',
                field: 'personRisks'
            },
            {
                id: 'environment',
                title: 'Environment Risks',
                description: 'Risks related to the area the activity is taking place',
                examples: 'E.g., fire, storage, vehicle movements, security, falling tree debris, equipment failure, disposal of waste',
                field: 'environmentRisks'
            },
            {
                id: 'activity',
                title: 'Specific Activity Related Risks',
                description: 'Risks specific to the activity being performed',
                examples: 'E.g., using scalpels, animal husbandry, kiln, woodworking tools, sports specific',
                field: 'activityRisks'
            }
        ];

        let currentStep = 0;
        let steps = [];
        let data = {
            assessmentType: '',
            activityName: '',
            date: '',
            assessor: '',
            typeSpecific: {},
            personRisks: [],
            environmentRisks: [],
            activityRisks: [],
            comments: '',
            allergies: [],
            medications: [],
            actions: [],
            activities: {}
        };
        let isDraft = false;
        let hasUnsavedChanges = false;

        function buildSteps() {
            steps = [
                { title: 'Select Type', id: 'type' }
            ];

            if (data.assessmentType === 'allergy') {
                steps.push(
                    { title: 'Child Info', id: 'allergy_child' },
                    { title: 'Allergy Details', id: 'allergy_info' },
                    { title: 'Medical', id: 'allergy_medical' },
                    { title: 'Emergency', id: 'allergy_emergency' },
                    { title: 'Location', id: 'allergy_location' },
                    { title: 'Staff', id: 'allergy_staff' },
                    { title: 'Activities', id: 'allergy_activities' },
                    { title: 'Actions', id: 'allergy_actions' },
                    { title: 'Review', id: 'review' }
                );
            } else if (data.assessmentType) {
                steps.push(
                    { title: 'Basic Info', id: 'info' }
                );

                if (data.assessmentType === 'pre_booking') {
                    steps.push(
                        { title: 'Pre-Booking Details', id: 'typeSpecific' },
                        { title: 'Review', id: 'review' }
                    );
                } else {
                    steps.push({ title: 'Details', id: 'typeSpecific' });
                    
                    if (data.assessmentType !== 'peep') {
                        steps.push(
                            { title: 'Person Risks', id: 'person' },
                            { title: 'Environment', id: 'environment' },
                            { title: 'Activity Risks', id: 'activity' }
                        );
                    }

                    steps.push(
                        { title: 'Comments', id: 'comments' },
                        { title: 'Review', id: 'review' }
                    );
                }
            }
        }

        function initializeApp() {
            buildSteps();
            renderProgressLabels();
            renderStep();
            updateProgress();
            showSaveDraftButton();
        }

        function showSaveDraftButton() {
            if (currentStep > 0) {
                document.getElementById('saveDraftBtn').style.display = 'block';
            } else {
                document.getElementById('saveDraftBtn').style.display = 'none';
            }
        }

        function renderProgressLabels() {
            const labels = document.getElementById('progressLabels');
            labels.innerHTML = steps.map((step, index) => 
                `<div class="progress-label ${index === currentStep ? 'active' : ''}">${step.title}</div>`
            ).join('');
        }

        function updateProgress() {
            const fill = document.getElementById('progressFill');
            const percent = ((currentStep + 1) / steps.length) * 100;
            fill.style.width = percent + '%';
            renderProgressLabels();
            
            document.getElementById('prevBtn').disabled = currentStep === 0;
            
            if (currentStep === steps.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
            } else {
                document.getElementById('nextBtn').style.display = 'block';
            }

            showSaveDraftButton();
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
        }

        function renderStep() {
            const content = document.getElementById('stepContent');
            const step = steps[currentStep];

            switch(step.id) {
                case 'type':
                    renderTypeSelection(content);
                    break;
                case 'info':
                    renderBasicInfo(content);
                    break;
                case 'typeSpecific':
                    renderTypeSpecific(content);
                    break;
                case 'person':
                case 'environment':
                case 'activity':
                    renderRiskCategory(step.id);
                    break;
                case 'comments':
                    renderComments(content);
                    break;
                case 'allergy_child':
                    renderAllergyChild(content);
                    break;
                case 'allergy_info':
                    renderAllergyInfo(content);
                    break;
                case 'allergy_medical':
                    renderAllergyMedical(content);
                    break;
                case 'allergy_emergency':
                    renderAllergyEmergency(content);
                    break;
                case 'allergy_location':
                    renderAllergyLocation(content);
                    break;
                case 'allergy_staff':
                    renderAllergyStaff(content);
                    break;
                case 'allergy_activities':
                    renderAllergyActivities(content);
                    break;
                case 'allergy_actions':
                    renderAllergyActions(content);
                    break;
                case 'review':
                    renderReview();
                    break;
            }
        }

        function renderTypeSelection(content) {
            content.innerHTML = `
                <div class="info-box">
                    <h3>Select Risk Assessment Type</h3>
                    <p>Choose the type of risk assessment you need to complete. Click on the appropriate option below.</p>
                </div>
                <div style="display: grid; gap: 12px; margin-top: 20px;">
                    ${assessmentTypes.map(type => {
                        let description = '';
                        let icon = '';
                        switch(type.value) {
                            case 'allergy':
                                description = 'Comprehensive allergy management plan for students with allergies';
                                icon = 'üè•';
                                break;
                            case 'pre_booking':
                                description = 'Initial approval for school trips and off-site visits';
                                icon = 'üìÖ';
                                break;
                            case 'school_trip':
                                description = 'Detailed risk assessment for confirmed school trips';
                                icon = 'üöå';
                                break;
                            case 'onsite_event':
                                description = 'Risk assessment for events held on school premises';
                                icon = 'üé≠';
                                break;
                            case 'curriculum_activity':
                                description = 'Assessment for activities beyond standard curriculum';
                                icon = 'üìö';
                                break;
                            case 'temporary_disability':
                                description = 'Support planning for students with temporary injuries';
                                icon = 'ü¶Ω';
                                break;
                            case 'peep':
                                description = 'Personal emergency evacuation planning';
                                icon = 'üö®';
                                break;
                        }
                        return `
                            <button class="type-selection-btn" onclick="selectAssessmentType('${type.value}')" style="
                                padding: 20px;
                                background: white;
                                border: 2px solid #e5e7eb;
                                border-radius: 12px;
                                text-align: left;
                                cursor: pointer;
                                transition: all 0.2s;
                                display: flex;
                                align-items: flex-start;
                                gap: 16px;
                                hover: transform scale(1.02);
                            " onmouseover="this.style.borderColor='#d61b26'; this.style.backgroundColor='#fef2f2';" 
                               onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white';">
                                <div style="font-size: 32px; line-height: 1;">${icon}</div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">${type.label}</h4>
                                    <p style="margin: 0; color: #6b7280; font-size: 13px; line-height: 1.4;">${description}</p>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function selectAssessmentType(type) {
            data.assessmentType = type;
            buildSteps();
            renderProgressLabels();
            markUnsaved();
            nextStep(); // Automatically move to next step
        }

        // Allergy-specific functions
        function renderAllergyChild(content) {
            const d = data.typeSpecific || {};
            content.innerHTML = `
                <div class="info-box">
                    <h3>Child Information</h3>
                    <p>Basic details about the child requiring allergy risk assessment.</p>
                </div>
                <div class="form-group">
                    <label>Child's Full Name *</label>
                    <input type="text" id="childName" value="${d.childName || ''}" placeholder="Full name" />
                </div>
                <div class="row">
                    <div>
                        <label>Year Group/Class *</label>
                        <input type="text" id="yearGroup" value="${d.yearGroup || ''}" placeholder="e.g., Y3 / Hazel" />
                    </div>
                    <div>
                        <label>Date of Birth</label>
                        <input type="date" id="dob" value="${d.dob || ''}" />
                    </div>
                    <div>
                        <label>Assessment Date *</label>
                        <input type="date" id="assessmentDate" value="${d.assessmentDate || ''}" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Assessed by *</label>
                    <input type="text" id="assessor" value="${d.assessor || ''}" placeholder="Your name" />
                </div>
            `;

            document.getElementById('childName')?.addEventListener('input', e => { data.typeSpecific.childName = e.target.value; markUnsaved(); });
            document.getElementById('yearGroup')?.addEventListener('input', e => { data.typeSpecific.yearGroup = e.target.value; markUnsaved(); });
            document.getElementById('dob')?.addEventListener('change', e => { data.typeSpecific.dob = e.target.value; markUnsaved(); });
            document.getElementById('assessmentDate')?.addEventListener('change', e => { data.typeSpecific.assessmentDate = e.target.value; markUnsaved(); });
            document.getElementById('assessor')?.addEventListener('input', e => { data.typeSpecific.assessor = e.target.value; markUnsaved(); });
        }

        function renderAllergyInfo(content) {
            const d = data.typeSpecific || {};
            const allergyTypes = [
                'Dairy', 'Eggs', 'Nuts (all)', 'Peanuts', 'Fish', 
                'Shellfish', 'Wheat/Gluten', 'Soya', 'Sesame', 'Other'
            ];
            
            content.innerHTML = `
                <div class="info-box">
                    <h3>Allergy Information</h3>
                    <p>Details about the child's allergies and reactions.</p>
                </div>
                <div class="form-group">
                    <label>Allergy Type(s) *</label>
                    <div class="grid">
                        ${allergyTypes.map(a => `
                            <label class="checkbox">
                                <input type="checkbox" data-allergy="${a}" ${d.allergies && d.allergies.includes(a) ? 'checked' : ''} />
                                ${a}
                            </label>
                        `).join('')}
                    </div>
                </div>
                ${d.allergies && d.allergies.includes('Other') ? `
                    <div class="form-group">
                        <label>Other Allergies (please specify)</label>
                        <input type="text" id="allergy_otherAllergies" value="${d.otherAllergies || ''}" placeholder="Specify other allergies" />
                    </div>
                ` : ''}
                <div class="form-group">
                    <label>Severity Level *</label>
                    <select id="allergy_severity">
                        <option value="">-- Select severity --</option>
                        <option value="Mild" ${d.severity === 'Mild' ? 'selected' : ''}>Mild - Local reactions only</option>
                        <option value="Moderate" ${d.severity === 'Moderate' ? 'selected' : ''}>Moderate - Systemic reactions</option>
                        <option value="Severe" ${d.severity === 'Severe' ? 'selected' : ''}>Severe - Anaphylaxis risk</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type of Reaction</label>
                    <select id="allergy_reactionType">
                        <option value="">-- Select reaction type --</option>
                        <option value="Contact only" ${d.reactionType === 'Contact only' ? 'selected' : ''}>Contact only</option>
                        <option value="Ingestion only" ${d.reactionType === 'Ingestion only' ? 'selected' : ''}>Ingestion only</option>
                        <option value="Airborne/proximity" ${d.reactionType === 'Airborne/proximity' ? 'selected' : ''}>Airborne/proximity</option>
                        <option value="Multiple triggers" ${d.reactionType === 'Multiple triggers' ? 'selected' : ''}>Multiple triggers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Known Symptoms / Previous Reactions</label>
                    <textarea id="allergy_symptoms" rows="3" placeholder="Describe symptoms or past reactions">${d.symptoms || ''}</textarea>
                </div>
            `;

            document.getElementById('allergy_severity')?.addEventListener('change', e => { data.typeSpecific.severity = e.target.value; markUnsaved(); });
            document.getElementById('allergy_reactionType')?.addEventListener('change', e => { data.typeSpecific.reactionType = e.target.value; markUnsaved(); });
            document.getElementById('allergy_symptoms')?.addEventListener('input', e => { data.typeSpecific.symptoms = e.target.value; markUnsaved(); });
            document.getElementById('allergy_otherAllergies')?.addEventListener('input', e => { data.typeSpecific.otherAllergies = e.target.value; markUnsaved(); });

            document.querySelectorAll('[data-allergy]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const allergy = e.target.dataset.allergy;
                    if (!data.typeSpecific.allergies) data.typeSpecific.allergies = [];
                    if (e.target.checked) {
                        if (!data.typeSpecific.allergies.includes(allergy)) {
                            data.typeSpecific.allergies.push(allergy);
                        }
                    } else {
                        data.typeSpecific.allergies = data.typeSpecific.allergies.filter(a => a !== allergy);
                    }
                    markUnsaved();
                    if (allergy === 'Other') renderAllergyInfo(content);
                });
            });
        }

        function renderAllergyMedical(content) {
            const d = data.typeSpecific || {};
            let medsHtml = '';
            if (d.medications && d.medications.length > 0) {
                medsHtml = d.medications.map((med, i) => `
                    <div class="action-card">
                        <div class="action-header">
                            <h4>Medication #${i + 1}</h4>
                            <button class="btn-danger" onclick="deleteAllergyMedication(${i})">Delete</button>
                        </div>
                        <div class="form-group">
                            <label>Medication Type</label>
                            <input type="text" value="${med.type || ''}" placeholder="e.g., EpiPen, Antihistamine, Inhaler" data-med-index="${i}" data-field="type">
                        </div>
                        <div class="row">
                            <div>
                                <label>Strength</label>
                                <input type="text" value="${med.strength || ''}" placeholder="e.g., 0.3mg, 10mg" data-med-index="${i}" data-field="strength">
                            </div>
                            <div>
                                <label>Dosage</label>
                                <input type="text" value="${med.dosage || ''}" placeholder="e.g., 1 dose as needed" data-med-index="${i}" data-field="dosage">
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                medsHtml = '<p style="color: #6b7280; text-align: center; padding: 20px;">No medications added yet.</p>';
            }

            content.innerHTML = `
                <div class="info-box">
                    <h3>Medical Information</h3>
                    <p>Document all medications required for allergy management.</p>
                </div>
                <div id="allergy_meds_list">${medsHtml}</div>
                <button class="btn-dashed" onclick="addAllergyMedication()">+ Add Medication</button>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Location of Medication</label>
                    <input type="text" id="allergy_medicationLocation" value="${d.medicationLocation || ''}" placeholder="Where medication is stored">
                </div>
            `;

            document.querySelectorAll('[data-med-index]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const i = parseInt(e.target.dataset.medIndex);
                    const field = e.target.dataset.field;
                    if (!data.typeSpecific.medications) data.typeSpecific.medications = [];
                    data.typeSpecific.medications[i] = data.typeSpecific.medications[i] || {};
                    data.typeSpecific.medications[i][field] = e.target.value;
                    markUnsaved();
                });
            });
            document.getElementById('allergy_medicationLocation')?.addEventListener('input', e => { data.typeSpecific.medicationLocation = e.target.value; markUnsaved(); });
        }

        window.addAllergyMedication = function() {
            if (!data.typeSpecific.medications) data.typeSpecific.medications = [];
            data.typeSpecific.medications.push({ type: '', strength: '', dosage: '' });
            markUnsaved();
            renderStep();
        };

        window.deleteAllergyMedication = function(index) {
            if (confirm('Remove this medication?')) {
                data.typeSpecific.medications.splice(index, 1);
                markUnsaved();
                renderStep();
            }
        };

        window.selectAssessmentType = function(type) {
            data.assessmentType = type;
            buildSteps();
            renderProgressLabels();
            markUnsaved();
            nextStep(); // Automatically move to next step
        };

        function renderAllergyEmergency(content) {
            const d = data.typeSpecific || {};
            content.innerHTML = `
                <div class="info-box">
                    <h3>Emergency Contacts</h3>
                    <p>Important contact information in case of an allergic reaction.</p>
                </div>
                <div class="row">
                    <div>
                        <label>Primary Contact Name</label>
                        <input type="text" id="primaryContactName" value="${d.primaryContactName || ''}" />
                    </div>
                    <div>
                        <label>Primary Contact Phone</label>
                        <input type="tel" id="primaryContactPhone" value="${d.primaryContactPhone || ''}" />
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label>Secondary Contact Name</label>
                        <input type="text" id="secondaryContactName" value="${d.secondaryContactName || ''}" />
                    </div>
                    <div>
                        <label>Secondary Contact Phone</label>
                        <input type="tel" id="secondaryContactPhone" value="${d.secondaryContactPhone || ''}" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Home Address</label>
                    <textarea id="homeAddress" rows="2">${d.homeAddress || ''}</textarea>
                </div>
            `;

            document.getElementById('primaryContactName')?.addEventListener('input', e => { data.typeSpecific.primaryContactName = e.target.value; markUnsaved(); });
            document.getElementById('primaryContactPhone')?.addEventListener('input', e => { data.typeSpecific.primaryContactPhone = e.target.value; markUnsaved(); });
            document.getElementById('secondaryContactName')?.addEventListener('input', e => { data.typeSpecific.secondaryContactName = e.target.value; markUnsaved(); });
            document.getElementById('secondaryContactPhone')?.addEventListener('input', e => { data.typeSpecific.secondaryContactPhone = e.target.value; markUnsaved(); });
            document.getElementById('homeAddress')?.addEventListener('input', e => { data.typeSpecific.homeAddress = e.target.value; markUnsaved(); });
        }

        function renderAllergyLocation(content) {
            const d = data.typeSpecific || {};
            content.innerHTML = `
                <div class="info-box">
                    <h3>Location & Environment</h3>
                    <p>Where is the child at greatest risk?</p>
                </div>
                <div class="form-group">
                    <label>Primary Learning Location</label>
                    <select id="allergy_primaryLocation">
                        <option value="">-- Select --</option>
                        <option value="Nursery/Reception" ${d.primaryLocation === 'Nursery/Reception' ? 'selected' : ''}>Nursery/Reception</option>
                        <option value="The Patch" ${d.primaryLocation === 'The Patch' ? 'selected' : ''}>The Patch</option>
                        <option value="1995 Building" ${d.primaryLocation === '1995 Building' ? 'selected' : ''}>1995 Building</option>
                        <option value="2018 Building" ${d.primaryLocation === '2018 Building' ? 'selected' : ''}>2018 Building</option>
                        <option value="Playground" ${d.primaryLocation === 'Playground' ? 'selected' : ''}>Playground</option>
                        <option value="Dining Room" ${d.primaryLocation === 'Dining Room' ? 'selected' : ''}>Dining Room</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>What3Words Emergency Location</label>
                    <select id="allergy_w3w">
                        <option value="">-- Select --</option>
                        <option value="arena.popped.honey" ${d.w3w === 'arena.popped.honey' ? 'selected' : ''}>Getting Better Bay/Office - arena.popped.honey</option>
                        <option value="stop.duty.watch" ${d.w3w === 'stop.duty.watch' ? 'selected' : ''}>Playground - stop.duty.watch</option>
                        <option value="pipe.photos.joins" ${d.w3w === 'pipe.photos.joins' ? 'selected' : ''}>Summerhill Field - pipe.photos.joins</option>
                        <option value="sands.begun.mock" ${d.w3w === 'sands.begun.mock' ? 'selected' : ''}>APG - sands.begun.mock</option>
                        <option value="spine.shut.pillow" ${d.w3w === 'spine.shut.pillow' ? 'selected' : ''}>Cow Field - spine.shut.pillow</option>
                        <option value="flip.dishes.budget" ${d.w3w === 'flip.dishes.budget' ? 'selected' : ''}>Secret Garden - flip.dishes.budget</option>
                        <option value="lock.storm.rock" ${d.w3w === 'lock.storm.rock' ? 'selected' : ''}>2018 Building - lock.storm.rock</option>
                        <option value="quarrel.leaned.larger" ${d.w3w === 'quarrel.leaned.larger' ? 'selected' : ''}>Garden/Nursery - quarrel.leaned.larger</option>
                    </select>
                </div>
            `;
            
            document.getElementById('allergy_primaryLocation')?.addEventListener('change', e => { data.typeSpecific.primaryLocation = e.target.value; markUnsaved(); });
            document.getElementById('allergy_w3w')?.addEventListener('change', e => { data.typeSpecific.w3w = e.target.value; markUnsaved(); });
        }

        function renderAllergyStaff(content) {
            const d = data.typeSpecific || {};
            const trainingTypes = ['EpiPen/Auto-injector training', 'Paediatric First Aid', 'Anaphylaxis recognition', 'General allergy awareness'];
            
            content.innerHTML = `
                <div class="info-box">
                    <h3>Staff Awareness & Training</h3>
                    <p>Which staff need to be informed and trained?</p>
                </div>
                <div class="form-group">
                    <label>Training Required</label>
                    <div class="grid">
                        ${trainingTypes.map(t => `
                            <label class="checkbox">
                                <input type="checkbox" data-training="${t}" ${d.training && d.training.includes(t) ? 'checked' : ''} />
                                ${t}
                            </label>
                        `).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label>Specific Staff Instructions</label>
                    <textarea id="allergy_staffInstructions" rows="3">${d.staffInstructions || ''}</textarea>
                </div>
            `;

            document.getElementById('allergy_staffInstructions')?.addEventListener('input', e => { data.typeSpecific.staffInstructions = e.target.value; markUnsaved(); });
            document.querySelectorAll('[data-training]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const training = e.target.dataset.training;
                    if (!data.typeSpecific.training) data.typeSpecific.training = [];
                    if (e.target.checked) {
                        if (!data.typeSpecific.training.includes(training)) {
                            data.typeSpecific.training.push(training);
                        }
                    } else {
                        data.typeSpecific.training = data.typeSpecific.training.filter(t => t !== training);
                    }
                    markUnsaved();
                });
            });
        }

        function renderAllergyActivities(content) {
            const d = data.typeSpecific || {};
            const activityFields = [
                { id: 'crayons', label: 'Crayons/painting' },
                { id: 'creative', label: 'Creative activities (craft paste/glue, pasta)' },
                { id: 'science', label: 'Science activities (bird feeders, planting seeds, food)' },
                { id: 'music', label: 'Musical instrument sharing (cross contamination)' },
                { id: 'cooking', label: 'Cooking (food prep area and ingredients)' },
                { id: 'mealtime', label: 'Meal time' },
                { id: 'kitchen', label: 'Kitchen prepared food (allergy information available)' },
                { id: 'packed', label: 'Packed lunches' },
                { id: 'snacks', label: 'Snacks (allergy information available)' },
                { id: 'drinks', label: 'Drinks' },
                { id: 'celebrations', label: 'Celebrations (Birthday, Easter, etc.)' },
                { id: 'handwashing', label: 'Hand washing (secondary school accessibility)' },
                { id: 'indoorpe', label: 'Indoor play/PE (AAIs with child)' },
                { id: 'outdoorpe', label: 'Outdoor play/PE (AAIs with child)' },
                { id: 'field', label: 'School field (AAIs with child)' },
                { id: 'forest', label: 'Forest school (AAIs with child)' },
                { id: 'trips', label: 'Offsite trips (staff trained to use AAI)' }
            ];

            let tableRows = '';
            activityFields.forEach(field => {
                const activity = d.activities && d.activities[field.id] ? d.activities[field.id] : { notes: '', na: false };
                tableRows += `
                    <tr>
                        <td>${field.label}</td>
                        <td><textarea data-activity="${field.id}" placeholder="Enter risk management notes or procedures...">${activity.notes}</textarea></td>
                        <td>
                            <div class="na-checkbox">
                                <input type="checkbox" data-activity-na="${field.id}" ${activity.na ? 'checked' : ''}>
                                <label>N/A</label>
                            </div>
                        </td>
                    </tr>
                `;
            });

            content.innerHTML = `
                <div class="info-box">
                    <h3>Activity Risk Management</h3>
                    <p>Document risk management procedures for activities involving potential allergen exposure.</p>
                </div>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Activity</th>
                            <th>Risk Management Notes</th>
                            <th>N/A</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;

            document.querySelectorAll('[data-activity]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.dataset.activity;
                    if (!data.typeSpecific.activities) data.typeSpecific.activities = {};
                    if (!data.typeSpecific.activities[id]) data.typeSpecific.activities[id] = { notes: '', na: false };
                    data.typeSpecific.activities[id].notes = e.target.value;
                    markUnsaved();
                });
            });

            document.querySelectorAll('[data-activity-na]').forEach(el => {
                el.addEventListener('change', (e) => {
                    const id = e.target.dataset.activityNa;
                    if (!data.typeSpecific.activities) data.typeSpecific.activities = {};
                    if (!data.typeSpecific.activities[id]) data.typeSpecific.activities[id] = { notes: '', na: false };
                    data.typeSpecific.activities[id].na = e.target.checked;
                    markUnsaved();
                });
            });
        }

        function renderAllergyActions(content) {
            const d = data.typeSpecific || {};
            let actionsHtml = '';
            
            if (d.actions && d.actions.length > 0) {
                actionsHtml = d.actions.map((action, i) => `
                    <div class="action-card">
                        <div class="action-header">
                            <h4>Action #${i + 1}</h4>
                            <button class="btn-danger" onclick="deleteAllergyAction(${i})">Delete</button>
                        </div>
                        <div class="form-group">
                            <label>Action Required</label>
                            <input type="text" value="${action.title || ''}" placeholder="e.g., Weekly allergy training for all staff" data-action-index="${i}" data-field="title">
                        </div>
                        <div class="form-group">
                            <label>Responsible Person</label>
                            <input type="text" value="${action.responsible || ''}" placeholder="e.g., Class Teacher, First Aid Lead" data-action-index="${i}" data-field="responsible">
                        </div>
                        <div class="form-group">
                            <label>Implementation Details</label>
                            <textarea rows="2" placeholder="How will this action be implemented and monitored?" data-action-index="${i}" data-field="details">${action.details || ''}</textarea>
                        </div>
                    </div>
                `).join('');
            } else {
                actionsHtml = '<p style="color: #6b7280; text-align: center; padding: 20px;">No actions added yet.</p>';
            }

            content.innerHTML = `
                <div class="info-box">
                    <h3>Management Actions</h3>
                    <p>Document specific actions needed to manage this allergy effectively.</p>
                </div>
                <div id="allergy_actions_list">${actionsHtml}</div>
                <button class="btn-dashed" onclick="addAllergyAction()">+ Add New Action</button>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Assessment Completion</label>
                    <div class="row">
                        <div>
                            <label>Completed By</label>
                            <input type="text" id="completedBy" value="${d.completedBy || ''}" />
                        </div>
                        <div>
                            <label>Role/Position</label>
                            <input type="text" id="role" value="${d.role || ''}" />
                        </div>
                    </div>
                </div>
            `;

            document.querySelectorAll('[data-action-index]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const i = parseInt(e.target.dataset.actionIndex);
                    const field = e.target.dataset.field;
                    if (!data.typeSpecific.actions) data.typeSpecific.actions = [];
                    data.typeSpecific.actions[i] = data.typeSpecific.actions[i] || {};
                    data.typeSpecific.actions[i][field] = e.target.value;
                    markUnsaved();
                });
            });

            document.getElementById('completedBy')?.addEventListener('input', e => { data.typeSpecific.completedBy = e.target.value; markUnsaved(); });
            document.getElementById('role')?.addEventListener('input', e => { data.typeSpecific.role = e.target.value; markUnsaved(); });
        }

        window.addAllergyAction = function() {
            if (!data.typeSpecific.actions) data.typeSpecific.actions = [];
            data.typeSpecific.actions.push({ title: '', responsible: '', details: '' });
            markUnsaved();
            renderStep();
        };

        window.deleteAllergyAction = function(index) {
            if (confirm('Remove this action?')) {
                data.typeSpecific.actions.splice(index, 1);
                markUnsaved();
                renderStep();
            }
        };

        // Other type-specific and general functions
        function renderBasicInfo(content) {
            content.innerHTML = `
                <div class="form-group">
                    <label>Activity/Event Name *</label>
                    <input type="text" id="activityName" placeholder="e.g., Year 6 Field Trip" value="${data.activityName}">
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="date" value="${data.date}">
                </div>
                <div class="form-group">
                    <label>Assessed By *</label>
                    <input type="text" id="assessor" placeholder="Your name" value="${data.assessor}">
                </div>
            `;
            
            document.getElementById('activityName').addEventListener('input', (e) => { data.activityName = e.target.value; markUnsaved(); });
            document.getElementById('date').addEventListener('input', (e) => { data.date = e.target.value; markUnsaved(); });
            document.getElementById('assessor').addEventListener('input', (e) => { data.assessor = e.target.value; markUnsaved(); });
        }

        function renderTypeSpecific(content) {
            const type = data.assessmentType;
            let html = '';
            switch(type) {
                case 'pre_booking':
                    html = renderPreBookingForm();
                    break;
                case 'school_trip':
                    html = renderSchoolTripForm();
                    break;
                case 'onsite_event':
                    html = renderOnsiteEventForm();
                    break;
                case 'curriculum_activity':
                    html = renderCurriculumActivityForm();
                    break;
                case 'temporary_disability':
                    html = renderTemporaryDisabilityForm();
                    break;
                case 'peep':
                    html = renderPEEPForm();
                    break;
            }
            content.innerHTML = html;
            attachTypeSpecificListeners();
        }

        function renderPreBookingForm() {
            const d = data.typeSpecific;
            const specialistTeachers = [
                { email: 'kfox@kingswood.bath.sch.uk', name: 'K Fox' },
                { email: 'plortal@kingswood.bath.sch.uk', name: 'P Lortal' },
                { email: 'dmurphy@kingswood.bath.sch.uk', name: 'D Murphy' },
                { email: 'ishrubsole@kingswood.bath.sch.uk', name: 'I Shrubsole' },
                { email: 'nrobinson@kingswood.bath.sch.uk', name: 'N Robinson' },
                { email: 'ezukert@kingswood.bath.sch.uk', name: 'E Zukert' },
                { email: 'fharvey@kingswood.bath.sch.uk', name: 'F Harvey' },
                { email: 'hwebb@kingswood.bath.sch.uk', name: 'H Webb' },
                { email: 'mkeighley@kingswood.bath.sch.uk', name: 'M Keighley' }
            ];
            return `
                <div class="info-box">
                    <h3>Pre-Booking Trip Approval</h3>
                    <p>Complete this form at least 1 term before the trip. This allows for improved calendar management.</p>
                </div>
                <div class="form-group">
                    <label>Purpose of Trip *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Set out a clear rationale for the trip</p>
                    <textarea id="ts_purpose" rows="4" placeholder="Describe the educational purpose and benefits of this trip...">${d.purpose || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Date of Trip *</label>
                    <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                        <p style="font-size: 13px; color: #92400e; margin: 4px 0;">  ‚ö†Ô∏è   <strong>Important:</strong></p>
                        <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #92400e;">
                            <li>Y3/4 - trips on Mondays require 2 terms notice</li>
                            <li>Y5/6 - trips on Wednesdays require 2 terms notice</li>
                            <li>Trips should generally avoid impacting Thursday after-school activities</li>
                        </ul>
                    </div>
                    <input type="date" id="ts_tripDate" value="${d.tripDate || ''}">
                </div>
                <div class="form-group">
                    <label>Alternate Suitable Dates</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Please provide alternative dates in case the preferred date is not available</p>
                    <textarea id="ts_alternateDates" rows="3" placeholder="e.g., Monday 15th March, Wednesday 24th March, or any Monday in March">${d.alternateDates || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Trip Timings (approx.) *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Approximate departure and return times</p>
                    <input type="text" id="ts_tripTimings" value="${d.tripTimings || ''}" placeholder="e.g., Depart 9:00 AM, Return 3:30 PM">
                </div>
                <div class="form-group">
                    <label>Pupils: Year/Group and Number Attending *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Specify which year group(s) and approximately how many pupils</p>
                    <input type="text" id="ts_pupils" value="${d.pupils || ''}" placeholder="e.g., Year 5 - 28 pupils">
                </div>
                <div class="form-group">
                    <label>Staff: Who and Number Attending *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">List staff members and total number</p>
                    <textarea id="ts_staffAttending" rows="3" placeholder="e.g., Mrs Smith, Mr Jones, Miss Brown - 3 staff members">${d.staffAttending || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Specialist Teachers Whose Lessons Will Be Affected *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">On approval, this form will alert the specialist teachers marked below of your trip approval.</p>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 12px;">
                        ${specialistTeachers.map(teacher => `
                            <div class="checkbox-group" style="margin-bottom: 10px;">
                                <input type="checkbox" id="ts_teacher_${teacher.email}" ${(d.affectedTeachers || []).includes(teacher.email) ? 'checked' : ''} data-teacher-email="${teacher.email}">
                                <label for="ts_teacher_${teacher.email}">${teacher.name} (${teacher.email})</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSchoolTripForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>School Trip / Off-site Visit Details</h3>
                    <p>Please provide all logistical information for this trip.</p>
                </div>
                <div class="form-group">
                    <label>Destination/Location (Include Address) *</label>
                    <input type="text" id="ts_destination" value="${d.destination || ''}" placeholder="e.g., Science Museum, Exhibition Road, South Kensington, London SW7 2DD">
                </div>
                <div class="form-group">
                    <label>Mode of Transport, Provider and Contact Details *</label>
                    <textarea id="ts_transport" rows="3" placeholder="e.g., Coach provided by ABC Travel, Contact: John Smith, Tel: 01234 567890">${d.transport || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Outbound Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_outboundDepartureTime" value="${d.outboundDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_outboundReturnTime" value="${d.outboundReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Return Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_returnDepartureTime" value="${d.returnDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_returnReturnTime" value="${d.returnReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Staff-to-Student Ratio *</label>
                    <input type="text" id="ts_ratio" value="${d.ratio || ''}" placeholder="e.g., 1:10">
                </div>
                <div class="form-group">
                    <label>Staff Members (Names, Contact Details and First Aid Qualified) *</label>
                    <textarea id="ts_staffNames" rows="5" placeholder="e.g., Mrs Sarah Smith - 07123 456789 - First Aid Qualified&#10;Mr John Jones - 07987 654321 - Not First Aid Qualified">${d.staffNames || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Students (Names) *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">You can either type the names below or upload a file</p>
                    <textarea id="ts_studentNames" rows="5" placeholder="List all students attending (one per line)&#10;e.g.,&#10;Emma Thompson&#10;James Wilson&#10;Sarah Brown">${d.studentNames || ''}</textarea>
                    <div style="margin-top: 12px;">
                        <label class="btn-secondary" style="display: inline-block; cursor: pointer; padding: 8px 16px; font-size: 13px;">
                            üìé   Upload Student List File (Optional)
                            <input type="file" id="ts_studentFile" accept=".txt,.csv,.doc,.docx" style="display: none;" onchange="handleStudentFileUpload(event)">
                        </label>
                        <span id="studentFileName" style="margin-left: 10px; font-size: 13px; color: #6b7280;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ts_medicalAck" ${d.medicalAck ? 'checked' : ''}>
                        <label for="ts_medicalAck">I acknowledge that I will take all medical information held by the school and ensure that all staff are aware of pupil conditions *</label>
                    </div>
                </div>
            `;
        }

        function renderOnsiteEventForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>On-site Event Details</h3>
                    <p>Please provide information about this on-site event.</p>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Expected Number of Visitors *</label>
                        <input type="number" id="ts_visitors" value="${d.visitors || ''}" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Expected Total Number of People *</label>
                        <input type="number" id="ts_totalPeople" value="${d.totalPeople || ''}" placeholder="e.g., 100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Venue/Rooms Being Used *</label>
                    <input type="text" id="ts_venue" value="${d.venue || ''}" placeholder="e.g., Main Hall, Classrooms 1-3">
                </div>
                <div class="form-group">
                    <label>Type of Event *</label>
                    <input type="text" id="ts_eventType" value="${d.eventType || ''}" placeholder="e.g., Sports Day, School Performance, Open Evening">
                </div>
                <div class="form-group">
                    <label>Parking Arrangements *</label>
                    <textarea id="ts_parking" rows="2" placeholder="Describe parking arrangements for visitors">${d.parking || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Timings of Event *</label>
                    <input type="text" id="ts_timings" value="${d.timings || ''}" placeholder="e.g., 2:00 PM - 5:00 PM">
                </div>
            `;
        }

        function renderCurriculumActivityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Curriculum Activity Details</h3>
                    <p>Describe the activity that requires assessment beyond normal classroom curriculum.</p>
                </div>
                <div class="form-group">
                    <label>What activity is taking place beyond the expected classroom curriculum that requires additional assessment? *</label>
                    <textarea id="ts_activityDescription" rows="5" placeholder="Describe the activity in detail...">${d.activityDescription || ''}</textarea>
                </div>
            `;
        }

        function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }
function formatLabelFromKey(key) {
    if (!key) return '';
    // strip ts_ prefix if present
    key = key.replace(/^ts_/, '');
    // replace underscores with spaces
    key = key.replace(/_/g, ' ');
    // split camelCase into words
    key = key.replace(/([a-z])([A-Z])/g, '$1 $2');
    // capitalise each word
    return key.replace(/\b\w/g, function (c) { return c.toUpperCase(); });
}

function renderTypeSpecificSummary() {
    const ts = data.typeSpecific || {};
    const entries = Object.entries(ts).filter(function ([key, value]) {
        if (value === null || value === undefined) return false;
        if (typeof value === 'string' && value.trim() === '') return false;
        if (Array.isArray(value) && value.length === 0) return false;
        // skip nested objects (like activities/actions) ‚Äì they‚Äôre handled separately if needed
        if (typeof value === 'object' && !Array.isArray(value)) return false;
        return true;
    });

    if (entries.length === 0) {
        return '';
    }

    let html = `
        <div class="info-box" style="margin-top: 20px;">
            <h3>Form Details</h3>
    `;

    entries.forEach(function ([key, value]) {
        let display = value;
        if (Array.isArray(display)) {
            display = display.join(', ');
        }
        html += `<p><strong>${formatLabelFromKey(key)}:</strong> ${display}</p>`;
    });

    html += `</div>`;
    return html;
}

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');

            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;

            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }

            content.innerHTML = html;

            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

       // ENHANCED renderReview() FUNCTION
// Replace your existing renderReview() function with this one

function renderReview() {
    const content = document.getElementById('stepContent');
    const isAllergy = data.assessmentType === 'allergy';
    const isPEEP = data.assessmentType === 'peep';
    let html = '';

    // ========== ALLERGY RISK ASSESSMENT REVIEW ==========
    if (isAllergy) {
        const d = data.typeSpecific || {};
        
        html = `
            <div class="info-box green">
                <h3>Allergy Risk Assessment Summary</h3>
                <p><strong>Child:</strong> ${d.childName || 'Not specified'}</p>
                <p><strong>Year Group:</strong> ${d.yearGroup || 'Not specified'}</p>
                <p><strong>Date of Birth:</strong> ${d.dob || 'Not specified'}</p>
                <p><strong>Assessment Date:</strong> ${d.assessmentDate || 'Not specified'}</p>
                <p><strong>Completed by:</strong> ${d.completedBy || d.assessor || 'Not specified'} ${d.role ? `(${d.role})` : ''}</p>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h4 style="color: #d61b26; margin-bottom: 12px;">Allergy Information</h4>
                <p><strong>Allergies:</strong> ${d.allergies ? d.allergies.join(', ') : 'Not specified'}</p>
                ${d.otherAllergies ? `<p><strong>Other Allergies:</strong> ${d.otherAllergies}</p>` : ''}
                <p><strong>Severity:</strong> ${d.severity || 'Not specified'}</p>
                <p><strong>Reaction Type:</strong> ${d.reactionType || 'Not specified'}</p>
                ${d.symptoms ? `<p><strong>Known Symptoms:</strong> ${d.symptoms}</p>` : ''}
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h4 style="color: #d61b26; margin-bottom: 12px;">Medical Information</h4>
                <p><strong>Medications:</strong> ${d.medications && d.medications.length > 0 ? d.medications.map(m => `${m.type} (${m.strength}, ${m.dosage})`).join('; ') : 'None specified'}</p>
                <p><strong>Medication Location:</strong> ${d.medicationLocation || 'Not specified'}</p>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h4 style="color: #d61b26; margin-bottom: 12px;">Emergency Contacts</h4>
                <p><strong>Primary:</strong> ${d.primaryContactName || 'Not specified'} - ${d.primaryContactPhone || 'Not specified'}</p>
                <p><strong>Secondary:</strong> ${d.secondaryContactName || 'Not specified'} - ${d.secondaryContactPhone || 'Not specified'}</p>
                ${d.homeAddress ? `<p><strong>Home Address:</strong> ${d.homeAddress}</p>` : ''}
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h4 style="color: #d61b26; margin-bottom: 12px;">Location & Training</h4>
                <p><strong>Primary Location:</strong> ${d.primaryLocation || 'Not specified'}</p>
                <p><strong>What3Words:</strong> ${d.w3w || 'Not specified'}</p>
                <p><strong>Staff Training:</strong> ${d.training ? d.training.join(', ') : 'Not specified'}</p>
                ${d.staffInstructions ? `<p><strong>Staff Instructions:</strong> ${d.staffInstructions}</p>` : ''}
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h4 style="color: #d61b26; margin-bottom: 12px;">Summary Statistics</h4>
                <div class="summary-grid">
                    <div class="summary-item">‚Ä¢ Total Allergies: ${d.allergies ? d.allergies.length : 0}</div>
                    <div class="summary-item">‚Ä¢ Medications: ${d.medications ? d.medications.length : 0} recorded</div>
                    <div class="summary-item">‚Ä¢ Management Actions: ${d.actions ? d.actions.length : 0} planned</div>
                    <div class="summary-item">‚Ä¢ Activities Assessed: ${d.activities ? Object.keys(d.activities).filter(k => d.activities[k].notes || d.activities[k].na).length : 0}</div>
                </div>
            </div>
        `;
    }
    
    // ========== NON-ALLERGY ASSESSMENTS REVIEW ==========
    else {
        const totalRisks = data.personRisks.length + data.environmentRisks.length + data.activityRisks.length;
        const d = data.typeSpecific || {};
        
        // Basic summary
        html = `
            <div class="info-box green">
                <h3>Assessment Summary</h3>
                <p><strong>Assessment Type:</strong> ${assessmentTypes.find(t => t.value === data.assessmentType)?.label || 'Not specified'}</p>
                <p><strong>Activity:</strong> ${data.activityName || 'Not specified'}</p>
                <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
                <p><strong>Assessed by:</strong> ${data.assessor || 'Not specified'}</p>
                ${!isPEEP ? `<p><strong>Total risks identified:</strong> ${totalRisks}</p>` : ''}
            </div>
        `;

        // ========== PRE-BOOKING DETAILS ==========
        if (data.assessmentType === 'pre_booking') {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>Pre-Booking Trip Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Purpose of Trip:</div>
                        <div class="detail-value">${d.purpose || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Proposed Date:</div>
                        <div class="detail-value">${d.tripDate || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Alternate Dates:</div>
                        <div class="detail-value">${d.alternateDates || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Trip Timings:</div>
                        <div class="detail-value">${d.tripTimings || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Pupils:</div>
                        <div class="detail-value">${d.pupils || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Staff Attending:</div>
                        <div class="detail-value">${d.staffAttending ? d.staffAttending.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Affected Teachers:</div>
                        <div class="detail-value">${d.affectedTeachers && d.affectedTeachers.length > 0 ? d.affectedTeachers.join(', ') : 'None selected'}</div>
                    </div>
                </div>
            `;
        }

        // ========== SCHOOL TRIP DETAILS ==========
        else if (data.assessmentType === 'school_trip') {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>School Trip Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Destination:</div>
                        <div class="detail-value">${d.destination || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Transport Details:</div>
                        <div class="detail-value">${d.transport ? d.transport.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Outbound Journey:</div>
                        <div class="detail-value">Depart: ${d.outboundDepartureTime || 'Not specified'} | Return: ${d.outboundReturnTime || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Return Journey:</div>
                        <div class="detail-value">Depart: ${d.returnDepartureTime || 'Not specified'} | Return: ${d.returnReturnTime || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Staff:Student Ratio:</div>
                        <div class="detail-value">${d.ratio || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Staff Members:</div>
                        <div class="detail-value">${d.staffNames ? d.staffNames.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Students:</div>
                        <div class="detail-value">${d.studentFileName ? `<em>Uploaded file: ${d.studentFileName}</em><br>` : ''}${d.studentNames ? d.studentNames.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Medical Acknowledgement:</div>
                        <div class="detail-value">${d.medicalAck ? '‚úì Acknowledged' : '‚ö†Ô∏è Not acknowledged'}</div>
                    </div>
                </div>
            `;
        }

        // ========== ON-SITE EVENT DETAILS ==========
        else if (data.assessmentType === 'onsite_event') {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>On-site Event Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Event Type:</div>
                        <div class="detail-value">${d.eventType || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Venue/Rooms:</div>
                        <div class="detail-value">${d.venue || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Expected Visitors:</div>
                        <div class="detail-value">${d.visitors || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Total People:</div>
                        <div class="detail-value">${d.totalPeople || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Timings:</div>
                        <div class="detail-value">${d.timings || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Parking:</div>
                        <div class="detail-value">${d.parking ? d.parking.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // ========== CURRICULUM ACTIVITY DETAILS ==========
        else if (data.assessmentType === 'curriculum_activity') {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>Curriculum Activity Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Activity Description:</div>
                        <div class="detail-value">${d.activityDescription ? d.activityDescription.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // ========== TEMPORARY DISABILITY DETAILS ==========
        else if (data.assessmentType === 'temporary_disability') {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>Temporary Disability Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Injured Party:</div>
                        <div class="detail-value">${d.injuredName || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Injury:</div>
                        <div class="detail-value">${d.injury ? d.injury.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Medical Info:</div>
                        <div class="detail-value">${d.medicalInfo ? d.medicalInfo.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Parent Info:</div>
                        <div class="detail-value">${d.parentInfo ? d.parentInfo.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // ========== PEEP DETAILS ==========
        else if (isPEEP) {
            html += `
                <div class="info-box blue" style="margin-top: 20px;">
                    <h4>PEEP Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Individual Name:</div>
                        <div class="detail-value">${d.peepName || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Disability/Condition:</div>
                        <div class="detail-value">${d.disability ? d.disability.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Mobility Needs:</div>
                        <div class="detail-value">${d.mobilityNeeds ? d.mobilityNeeds.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Communication Needs:</div>
                        <div class="detail-value">${d.communicationNeeds ? d.communicationNeeds.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Evacuation Procedures:</div>
                        <div class="detail-value">${d.evacuationProcedures ? d.evacuationProcedures.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Assistance Personnel:</div>
                        <div class="detail-value">${d.assistancePersonnel || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Assembly Point:</div>
                        <div class="detail-value">${d.assemblyPoint ? d.assemblyPoint.replace(/\n/g, '<br>') : 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Equipment Required:</div>
                        <div class="detail-value">${d.equipment || 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // ========== RISKS OVERVIEW (for non-PEEP assessments) ==========
        if (!isPEEP && totalRisks > 0) {
            html += `
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-top: 20px;">
                    <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 16px; font-size: 17px;">Risk Assessment Details</h3>
            `;

            // Person Risks
            if (data.personRisks.length > 0) {
                html += `
                    <h4 style="color: #374151; margin-top: 20px;">Person Risks (${data.personRisks.length})</h4>
                `;
                data.personRisks.forEach((risk, index) => {
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 13px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Risk #${index + 1}</div>
                            <div class="detail-row">
                                <div class="detail-label">Hazard:</div>
                                <div class="detail-value">${risk.hazard || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Affected:</div>
                                <div class="detail-value">${risk.affected || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Measures:</div>
                                <div class="detail-value">${risk.measures || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Emergency Steps:</div>
                                <div class="detail-value">${risk.emergency || 'Not specified'}</div>
                            </div>
                        </div>
                    `;
                });
            }

            // Environment Risks
            if (data.environmentRisks.length > 0) {
                html += `
                    <h4 style="color: #374151; margin-top: 20px;">Environment Risks (${data.environmentRisks.length})</h4>
                `;
                data.environmentRisks.forEach((risk, index) => {
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 13px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Risk #${index + 1}</div>
                            <div class="detail-row">
                                <div class="detail-label">Hazard:</div>
                                <div class="detail-value">${risk.hazard || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Affected:</div>
                                <div class="detail-value">${risk.affected || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Measures:</div>
                                <div class="detail-value">${risk.measures || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Emergency Steps:</div>
                                <div class="detail-value">${risk.emergency || 'Not specified'}</div>
                            </div>
                        </div>
                    `;
                });
            }

            // Activity Risks
            if (data.activityRisks.length > 0) {
                html += `
                    <h4 style="color: #374151; margin-top: 20px;">Activity Risks (${data.activityRisks.length})</h4>
                `;
                data.activityRisks.forEach((risk, index) => {
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 13px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Risk #${index + 1}</div>
                            <div class="detail-row">
                                <div class="detail-label">Hazard:</div>
                                <div class="detail-value">${risk.hazard || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Affected:</div>
                                <div class="detail-value">${risk.affected || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Measures:</div>
                                <div class="detail-value">${risk.measures || 'Not specified'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Emergency Steps:</div>
                                <div class="detail-value">${risk.emergency || 'Not specified'}</div>
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>'; // Close risks overview
        } else if (!isPEEP) {
            html += `
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-top: 20px;">
                    <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 16px; font-size: 17px;">Risk Assessment Details</h3>
                    <p style="color: #6b7280; font-size: 13px;">No risks have been identified yet.</p>
                </div>
            `;
        }

        // Additional Comments
        if (data.comments && data.comments.trim() !== '') {
            html += `
                <div class="info-box" style="margin-top: 20px;">
                    <h4 style="color: #d61b26;">Additional Comments</h4>
                    <p>${data.comments.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }
    }

    // ========== SUBMISSION INSTRUCTIONS (All Types) ==========
    html += `
        <div class="info-box" style="margin-top: 20px; background: #fef3c7; border-color: #f59e0b;">
            <h3 style="color: #92400e;">üìã Submission Process</h3>
            <p style="color: #92400e;">Follow these three steps to complete your risk assessment submission:</p>
        </div>
        
        <div style="display: grid; gap: 16px; margin-top: 20px;">
            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                <h4 style="margin: 0 0 8px 0; color: #374151;">Step 1: Save Editable Version</h4>
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #6b7280;">Keep this for your records - you can edit and update it later</p>
                <button class="btn-large btn-secondary" onclick="saveDraft()" style="width: 100%;">
                    üíæ Save Editable Draft (.json)
                </button>
            </div>

            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                <h4 style="margin: 0 0 8px 0; color: #374151;">Step 2: Download Final Submission</h4>
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #6b7280;">This is the official document for submission to SharePoint</p>
                <button class="btn-large btn-primary" onclick="generateHTML()" style="width: 100%;">
                    üìÑ Download Final Assessment (.html)
                </button>
            </div>

            <div style="background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 8px; padding: 20px;">
                <h4 style="margin: 0 0 8px 0; color: #065f46;">Step 3: Submit to SharePoint</h4>
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #047857;">Upload your HTML file to complete the submission process</p>
                <a class="btn-large btn-success" href="https://kingswoodschool48.sharepoint.com/:f:/s/ITSupportSharedFiles/IgD07OO65-dtTJ7Xy3MLqc-3AYOHKazynu3gocpD5VXrPQ8" target="_blank" style="width: 100%; text-decoration: none;">
                    üì§ Open SharePoint Upload Portal
                </a>
            </div>
        </div>

        <div class="info-box" style="margin-top: 20px; background: #eff6ff; border-color: #60a5fa;">
            <p style="color: #1e40af; margin: 0;"><strong>üí° Tip:</strong> Save the .json file first for your records, then download the .html file for official submission to SharePoint.</p>
        </div>
    `;

    content.innerHTML = html;
    hasUnsavedChanges = false;
}

function generateHTML() {
    const isAllergy = data.assessmentType === 'allergy';
    const isPEEP = data.assessmentType === 'peep';
    const today = new Date().toISOString().split('T')[0];

    // Determine filename based on type
    let fileName;
    if (isAllergy) {
        fileName = `Allergy_Risk_Assessment_${(data.typeSpecific.childName || 'Unknown').replace(/\s+/g, '_')}_${today}.html`;
    } else if (isPEEP) {
        fileName = `PEEP_${(data.typeSpecific.peepName || 'Unknown').replace(/\s+/g, '_')}_${today}.html`;
    } else {
        fileName = `Risk_Assessment_${(data.activityName || 'Unknown').replace(/\s+/g, '_')}_${today}.html`;
    }

    let htmlContent = `<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <title>Risk Assessment - ${isAllergy ? (data.typeSpecific.childName || 'Unknown') : isPEEP ? (data.typeSpecific.peepName || 'Unknown') : (data.activityName || 'Unknown')}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20mm; line-height: 1.6; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        h2 { color: #444; margin-top: 24px; margin-bottom: 10px; border-bottom: 2px solid #333; padding-bottom: 4px; }
        h3 { color: #444; margin-top: 18px; margin-bottom: 8px; }
        .header-info p { margin: 4px 0; }
        .section { margin-bottom: 16px; padding: 10px 12px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; page-break-inside: avoid; }
        .section p { margin: 6px 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        th, td { padding: 8px; border: 1px solid #ccc; vertical-align: top; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .risk-category { page-break-inside: avoid; }
        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
        .highlight { background-color: #fff3cd; padding: 12px; border-left: 4px solid #ffc107; margin: 16px 0; }
        .warning { background-color: #fee; padding: 12px; border-left: 4px solid #dc3545; margin: 16px 0; }
        .info { background-color: #e7f3ff; padding: 12px; border-left: 4px solid #0d6efd; margin: 16px 0; }
    </style>
</head>
<body>`;

    // ========== ALLERGY RISK ASSESSMENT ==========
    if (isAllergy) {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>ALLERGY RISK ASSESSMENT</h1>
    
    <div class="header-info section">
        <p><strong>Child's Name:</strong> ${d.childName || 'Not specified'}</p>
        <p><strong>Year Group/Class:</strong> ${d.yearGroup || 'Not specified'}</p>
        <p><strong>Date of Birth:</strong> ${d.dob || 'Not specified'}</p>
        <p><strong>Assessment Date:</strong> ${d.assessmentDate || 'Not specified'}</p>
        <p><strong>Completed By:</strong> ${d.completedBy || 'Not specified'} (${d.role || 'Not specified'})</p>
    </div>

    <h2>Allergy Information</h2>
    <div class="section">
        <p><strong>Allergy Type(s):</strong> ${d.allergies && d.allergies.length > 0 ? d.allergies.join(', ') : 'Not specified'}</p>
        ${d.otherAllergies ? `<p><strong>Other Allergies:</strong> ${d.otherAllergies}</p>` : ''}
        <p><strong>Severity Level:</strong> ${d.severity || 'Not specified'}</p>
        <p><strong>Type of Reaction:</strong> ${d.reactionType || 'Not specified'}</p>
        ${d.symptoms ? `<p><strong>Known Symptoms/Previous Reactions:</strong><br>${d.symptoms.replace(/\n/g, '<br>')}</p>` : ''}
    </div>
`;

        if (d.severity === 'Severe') {
            htmlContent += `
    <div class="warning">
        <p><strong>‚ö†Ô∏è SEVERE ALLERGY - ANAPHYLAXIS RISK</strong></p>
        <p>This child has a severe allergy with risk of anaphylaxis. All staff must be aware of emergency procedures.</p>
    </div>
`;
        }

        if (d.medications && d.medications.length > 0) {
            htmlContent += `
    <h2>Medications</h2>
    <table>
        <thead>
            <tr>
                <th>Medication Type</th>
                <th>Strength</th>
                <th>Dosage</th>
            </tr>
        </thead>
        <tbody>
`;
            d.medications.forEach(med => {
                htmlContent += `
            <tr>
                <td>${med.type || 'Not specified'}</td>
                <td>${med.strength || 'Not specified'}</td>
                <td>${med.dosage || 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>

    <div class="section">
        <p><strong>Medication Location:</strong> ${d.medicationLocation || 'Not specified'}</p>
    </div>
`;
        } else {
            htmlContent += `
    <h2>Medications</h2>
    <div class="section">
        <p><strong>Medication Location:</strong> ${d.medicationLocation || 'Not specified'}</p>
        <p><em>No medications recorded</em></p>
    </div>
`;
        }

        htmlContent += `
    <h2>Emergency Contacts</h2>
    <table>
        <thead>
            <tr>
                <th>Contact Type</th>
                <th>Name</th>
                <th>Phone Number</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Primary Contact</td>
                <td>${d.primaryContactName || 'Not specified'}</td>
                <td>${d.primaryContactPhone || 'Not specified'}</td>
            </tr>
            <tr>
                <td>Secondary Contact</td>
                <td>${d.secondaryContactName || 'Not specified'}</td>
                <td>${d.secondaryContactPhone || 'Not specified'}</td>
            </tr>
        </tbody>
    </table>
`;

        if (d.homeAddress) {
            htmlContent += `
    <div class="section">
        <p><strong>Home Address:</strong><br>${d.homeAddress.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }

        htmlContent += `
    <h2>Location & Environment</h2>
    <div class="section">
        <p><strong>Primary Learning Location:</strong> ${d.primaryLocation || 'Not specified'}</p>
        <p><strong>What3Words Emergency Location:</strong> ${d.w3w || 'Not specified'}</p>
    </div>

    <h2>Staff Awareness & Training</h2>
    <div class="section">
        <p><strong>Training Required:</strong> ${d.training && d.training.length > 0 ? d.training.join(', ') : 'Not specified'}</p>
        ${d.staffInstructions ? `<p><strong>Specific Staff Instructions:</strong><br>${d.staffInstructions.replace(/\n/g, '<br>')}</p>` : ''}
    </div>
`;

        if (d.activities && Object.keys(d.activities).length > 0) {
            const activityLabels = {
                crayons: 'Crayons/painting',
                creative: 'Creative activities (craft paste/glue, pasta)',
                science: 'Science activities (bird feeders, planting seeds, food)',
                music: 'Musical instrument sharing (cross contamination)',
                cooking: 'Cooking (food prep area and ingredients)',
                mealtime: 'Meal time',
                kitchen: 'Kitchen prepared food (allergy information available)',
                packed: 'Packed lunches',
                snacks: 'Snacks (allergy information available)',
                drinks: 'Drinks',
                celebrations: 'Celebrations (Birthday, Easter, etc.)',
                handwashing: 'Hand washing (secondary school accessibility)',
                indoorpe: 'Indoor play/PE (AAIs with child)',
                outdoorpe: 'Outdoor play/PE (AAIs with child)',
                field: 'School field (AAIs with child)',
                forest: 'Forest school (AAIs with child)',
                trips: 'Offsite trips (staff trained to use AAI)'
            };

            const hasActivities = Object.values(d.activities).some(a => a.notes || a.na);
            
            if (hasActivities) {
                htmlContent += `
    <h2>Activity Risk Management</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 40%;">Activity</th>
                <th style="width: 50%;">Risk Management Notes</th>
                <th style="width: 10%;">Status</th>
            </tr>
        </thead>
        <tbody>
`;
                Object.entries(activityLabels).forEach(([key, label]) => {
                    const activity = d.activities[key] || { notes: '', na: false };
                    if (activity.notes || activity.na) {
                        htmlContent += `
            <tr>
                <td>${label}</td>
                <td>${activity.notes ? activity.notes.replace(/\n/g, '<br>') : 'No notes provided'}</td>
                <td style="text-align: center;">${activity.na ? 'N/A' : '‚úì'}</td>
            </tr>
`;
                    }
                });
                htmlContent += `
        </tbody>
    </table>
`;
            }
        }

        if (d.actions && d.actions.length > 0) {
            htmlContent += `
    <h2>Management Actions</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 25%;">Action Required</th>
                <th style="width: 20%;">Responsible Person</th>
                <th style="width: 55%;">Implementation Details</th>
            </tr>
        </thead>
        <tbody>
`;
            d.actions.forEach(action => {
                htmlContent += `
            <tr>
                <td>${action.title || 'Not specified'}</td>
                <td>${action.responsible || 'Not specified'}</td>
                <td>${action.details ? action.details.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>
`;
        }
    }
    
    // ========== PRE-BOOKING TRIP APPROVAL ==========
    else if (data.assessmentType === 'pre_booking') {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>PRE-BOOKING TRIP APPROVAL</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <div class="info">
        <p><strong>‚ÑπÔ∏è Pre-Booking Requirements</strong></p>
        <p>This form should be completed at least 1 term before the trip for improved calendar management.</p>
    </div>

    <h2>Trip Details</h2>
    <div class="section">
        <p><strong>Purpose of Trip:</strong><br>${d.purpose ? d.purpose.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>

    <div class="section">
        <p><strong>Proposed Date of Trip:</strong> ${d.tripDate || 'Not specified'}</p>
        <p><strong>Alternate Suitable Dates:</strong><br>${d.alternateDates ? d.alternateDates.replace(/\n/g, '<br>') : 'Not specified'}</p>
        <p><strong>Trip Timings (approx.):</strong> ${d.tripTimings || 'Not specified'}</p>
    </div>

    <h2>Participants</h2>
    <div class="section">
        <p><strong>Pupils:</strong> ${d.pupils || 'Not specified'}</p>
        <p><strong>Staff Attending:</strong><br>${d.staffAttending ? d.staffAttending.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>
`;

        if (d.affectedTeachers && d.affectedTeachers.length > 0) {
            htmlContent += `
    <h2>Affected Specialist Teachers</h2>
    <div class="highlight">
        <p><strong>The following specialist teachers will be notified of this trip approval:</strong></p>
        <ul>
`;
            d.affectedTeachers.forEach(email => {
                htmlContent += `            <li>${email}</li>\n`;
            });
            htmlContent += `
        </ul>
    </div>
`;
        }
    }
    
    // ========== SCHOOL TRIP / OFF-SITE VISIT ==========
    else if (data.assessmentType === 'school_trip') {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>SCHOOL TRIP / OFF-SITE VISIT</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <h2>Destination Details</h2>
    <div class="section">
        <p><strong>Destination/Location:</strong><br>${d.destination || 'Not specified'}</p>
    </div>

    <h2>Transport Arrangements</h2>
    <div class="section">
        <p><strong>Mode of Transport, Provider and Contact Details:</strong><br>${d.transport ? d.transport.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>

    <h2>Journey Times</h2>
    <table>
        <thead>
            <tr>
                <th>Journey</th>
                <th>Departure Time</th>
                <th>Return Time</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Outbound</td>
                <td>${d.outboundDepartureTime || 'Not specified'}</td>
                <td>${d.outboundReturnTime || 'Not specified'}</td>
            </tr>
            <tr>
                <td>Return</td>
                <td>${d.returnDepartureTime || 'Not specified'}</td>
                <td>${d.returnReturnTime || 'Not specified'}</td>
            </tr>
        </tbody>
    </table>

    <h2>Staffing</h2>
    <div class="section">
        <p><strong>Staff-to-Student Ratio:</strong> ${d.ratio || 'Not specified'}</p>
        <p><strong>Staff Members (Names, Contact Details and First Aid Qualified):</strong><br>${d.staffNames ? d.staffNames.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>

    <h2>Students Attending</h2>
    <div class="section">
        ${d.studentFileName ? `<p><strong>Student List File:</strong> ${d.studentFileName}</p>` : ''}
        <p>${d.studentNames ? d.studentNames.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>

    <h2>Medical Acknowledgement</h2>
    <div class="${d.medicalAck ? 'section' : 'warning'}">
        <p>${d.medicalAck ? '‚úì' : '‚ö†Ô∏è'} <strong>${d.medicalAck ? 'Acknowledged:' : 'NOT ACKNOWLEDGED:'}</strong> ${d.medicalAck ? 'Trip leader acknowledges' : 'Trip leader must acknowledge'} taking all medical information and ensuring staff awareness of pupil conditions</p>
    </div>
`;

        // Add risk tables
        function addRiskTable(title, risksArray) {
            if (!risksArray || !risksArray.length) return;
            htmlContent += `
    <h2>${title}</h2>
    <table class="risk-category">
        <thead>
            <tr>
                <th>Risk</th>
                <th>Who Might Be Harmed</th>
                <th>Controls / Mitigations</th>
                <th>Emergency Procedures</th>
            </tr>
        </thead>
        <tbody>
`;
            risksArray.forEach(risk => {
                htmlContent += `
            <tr>
                <td>${(risk.hazard || '').trim() || 'Not specified'}</td>
                <td>${(risk.affected || '').trim() || 'Not specified'}</td>
                <td>${(risk.measures || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
                <td>${(risk.emergency || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>
`;
        }

        addRiskTable('Person Risks', data.personRisks || []);
        addRiskTable('Environment Risks', data.environmentRisks || []);
        addRiskTable('Activity Risks', data.activityRisks || []);

        if (data.comments && data.comments.trim() !== '') {
            htmlContent += `
    <h2>Additional Comments</h2>
    <div class="section">
        <p>${data.comments.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }
    }
    
    // ========== ON-SITE EVENT ==========
    else if (data.assessmentType === 'onsite_event') {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>ON-SITE EVENT RISK ASSESSMENT</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <h2>Event Details</h2>
    <table>
        <tbody>
            <tr>
                <th style="width: 40%;">Type of Event</th>
                <td>${d.eventType || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Timings of Event</th>
                <td>${d.timings || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Venue/Rooms Being Used</th>
                <td>${d.venue || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Expected Number of Visitors</th>
                <td>${d.visitors || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Expected Total Number of People</th>
                <td>${d.totalPeople || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Parking Arrangements</th>
                <td>${d.parking ? d.parking.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
        </tbody>
    </table>
`;

        function addRiskTable(title, risksArray) {
            if (!risksArray || !risksArray.length) return;
            htmlContent += `
    <h2>${title}</h2>
    <table class="risk-category">
        <thead>
            <tr>
                <th>Risk</th>
                <th>Who Might Be Harmed</th>
                <th>Controls / Mitigations</th>
                <th>Emergency Procedures</th>
            </tr>
        </thead>
        <tbody>
`;
            risksArray.forEach(risk => {
                htmlContent += `
            <tr>
                <td>${(risk.hazard || '').trim() || 'Not specified'}</td>
                <td>${(risk.affected || '').trim() || 'Not specified'}</td>
                <td>${(risk.measures || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
                <td>${(risk.emergency || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>
`;
        }

        addRiskTable('Person Risks', data.personRisks || []);
        addRiskTable('Environment Risks', data.environmentRisks || []);
        addRiskTable('Activity Risks', data.activityRisks || []);

        if (data.comments && data.comments.trim() !== '') {
            htmlContent += `
    <h2>Additional Comments</h2>
    <div class="section">
        <p>${data.comments.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }
    }
    
    // ========== CURRICULUM ACTIVITY ==========
    else if (data.assessmentType === 'curriculum_activity') {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>CURRICULUM ACTIVITY RISK ASSESSMENT</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <h2>Activity Description</h2>
    <div class="section">
        <p><strong>Activity beyond expected classroom curriculum requiring additional assessment:</strong></p>
        <p>${d.activityDescription ? d.activityDescription.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>
`;

        function addRiskTable(title, risksArray) {
            if (!risksArray || !risksArray.length) return;
            htmlContent += `
    <h2>${title}</h2>
    <table class="risk-category">
        <thead>
            <tr>
                <th>Risk</th>
                <th>Who Might Be Harmed</th>
                <th>Controls / Mitigations</th>
                <th>Emergency Procedures</th>
            </tr>
        </thead>
        <tbody>
`;
            risksArray.forEach(risk => {
                htmlContent += `
            <tr>
                <td>${(risk.hazard || '').trim() || 'Not specified'}</td>
                <td>${(risk.affected || '').trim() || 'Not specified'}</td>
                <td>${(risk.measures || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
                <td>${(risk.emergency || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>
`;
        }

        addRiskTable('Person Risks', data.personRisks || []);
        addRiskTable('Environment Risks', data.environmentRisks || []);
        addRiskTable('Activity Risks', data.activityRisks || []);

        if (data.comments && data.comments.trim() !== '') {
            htmlContent += `
    <h2>Additional Comments</h2>
    <div class="section">
        <p>${data.comments.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }
    }
    
    // ========== TEMPORARY DISABILITY ==========
    else if (data.assessmentType === 'temporary_disability') {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>TEMPORARY DISABILITY RISK ASSESSMENT</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <h2>Injured Party Details</h2>
    <table>
        <tbody>
            <tr>
                <th style="width: 40%;">Name of Injured Party</th>
                <td>${d.injuredName || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Injury Sustained</th>
                <td>${d.injury ? d.injury.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
            <tr>
                <th>Information from Medical Professional</th>
                <td>${d.medicalInfo ? d.medicalInfo.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
            <tr>
                <th>Information from Parents</th>
                <td>${d.parentInfo ? d.parentInfo.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
        </tbody>
    </table>
`;

        function addRiskTable(title, risksArray) {
            if (!risksArray || !risksArray.length) return;
            htmlContent += `
    <h2>${title}</h2>
    <table class="risk-category">
        <thead>
            <tr>
                <th>Risk</th>
                <th>Who Might Be Harmed</th>
                <th>Controls / Mitigations</th>
                <th>Emergency Procedures</th>
            </tr>
        </thead>
        <tbody>
`;
            risksArray.forEach(risk => {
                htmlContent += `
            <tr>
                <td>${(risk.hazard || '').trim() || 'Not specified'}</td>
                <td>${(risk.affected || '').trim() || 'Not specified'}</td>
                <td>${(risk.measures || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
                <td>${(risk.emergency || '').trim().replace(/\n/g, '<br>') || 'Not specified'}</td>
            </tr>
`;
            });
            htmlContent += `
        </tbody>
    </table>
`;
        }

        addRiskTable('Person Risks', data.personRisks || []);
        addRiskTable('Environment Risks', data.environmentRisks || []);
        addRiskTable('Activity Risks', data.activityRisks || []);

        if (data.comments && data.comments.trim() !== '') {
            htmlContent += `
    <h2>Additional Comments</h2>
    <div class="section">
        <p>${data.comments.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }
    }
    
    // ========== PEEP (Personal Emergency Evacuation Plan) ==========
    else if (isPEEP) {
        const d = data.typeSpecific || {};
        
        htmlContent += `
    <h1>PERSONAL EMERGENCY EVACUATION PLAN (PEEP)</h1>
    
    <div class="header-info section">
        <p><strong>Activity/Event:</strong> ${data.activityName || 'Not specified'}</p>
        <p><strong>Date:</strong> ${data.date || 'Not specified'}</p>
        <p><strong>Assessed By:</strong> ${data.assessor || 'Not specified'}</p>
    </div>

    <div class="warning">
        <p><strong>‚ö†Ô∏è EMERGENCY EVACUATION PLAN</strong></p>
        <p>This document outlines the specific evacuation procedures for an individual requiring assistance.</p>
    </div>

    <h2>Individual Details</h2>
    <table>
        <tbody>
            <tr>
                <th style="width: 40%;">Name of Individual</th>
                <td>${d.peepName || 'Not specified'}</td>
            </tr>
            <tr>
                <th>Nature of Disability/Condition</th>
                <td>${d.disability ? d.disability.replace(/\n/g, '<br>') : 'Not specified'}</td>
            </tr>
        </tbody>
    </table>

    <h2>Assistance Requirements</h2>
    <div class="section">
        <p><strong>Mobility/Assistance Requirements:</strong><br>${d.mobilityNeeds ? d.mobilityNeeds.replace(/\n/g, '<br>') : 'Not specified'}</p>
        <p><strong>Communication Needs:</strong><br>${d.communicationNeeds ? d.communicationNeeds.replace(/\n/g, '<br>') : 'Not specified'}</p>
        <p><strong>Equipment Required:</strong> ${d.equipment || 'Not specified'}</p>
    </div>

    <h2>Evacuation Procedures</h2>
    <div class="section">
        ${d.evacuationProcedures ? d.evacuationProcedures.replace(/\n/g, '<br>') : 'Not specified'}
    </div>

    <h2>Personnel & Assembly Point</h2>
    <div class="section">
        <p><strong>Designated Assistance Personnel:</strong> ${d.assistancePersonnel || 'Not specified'}</p>
        <p><strong>Assembly Point Arrangements:</strong><br>${d.assemblyPoint ? d.assemblyPoint.replace(/\n/g, '<br>') : 'Not specified'}</p>
    </div>
`;

        if (data.comments && data.comments.trim() !== '') {
            htmlContent += `
    <h2>Additional Comments</h2>
    <div class="section">
        <p>${data.comments.replace(/\n/g, '<br>')}</p>
    </div>
`;
        }
    }

    // ========== FOOTER ==========
    htmlContent += `
    <div class="footer">
        <p>Generated on ${new Date().toLocaleDateString('en-GB')}</p>
    </div>
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


        function saveDraft() {
            const draftData = {
                ...data,
                currentStep: currentStep,
                lastSaved: new Date().toISOString(),
                formVersion: FORM_VERSION
            };

            const json = JSON.stringify(draftData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const fileName = data.assessmentType === 'allergy' ?
                `Allergy_RA_Draft_${data.typeSpecific?.childName || 'Untitled'}_${new Date().toISOString().split('T')[0]}.json` :
                `Risk_Assessment_DRAFT_${data.activityName || 'Untitled'}_${new Date().toISOString().split('T')[0]}.json`;
            
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            hasUnsavedChanges = false;
            alert('Draft saved successfully! You can resume this assessment later by uploading this file.');
        }

        function loadDraft(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.assessmentType) {
                        alert('Invalid draft file.');
                        return;
                    }

                    data = loadedData;
                    currentStep = loadedData.currentStep || 0;
                    isDraft = true;

                    buildSteps();
                    document.getElementById('uploadSection').classList.add('hidden');
                    
                    const draftStatus = document.getElementById('draftStatus');
                    draftStatus.classList.remove('hidden');
                    
                    const lastSaved = loadedData.lastSaved ? new Date(loadedData.lastSaved).toLocaleString('en-GB') : 'Unknown';
                    document.getElementById('draftStatusText').textContent = `Draft loaded - Last saved: ${lastSaved}`;

                    renderStep();
                    updateProgress();
                    hasUnsavedChanges = false;

                    alert('Draft loaded successfully!');
                } catch (error) {
                    alert('Error loading draft file.');
                    console.error('Draft load error:', error);
                }
            };
            reader.readAsText(file);
        }

        function clearDraft() {
            if (!confirm('Are you sure you want to start a new assessment? Any unsaved changes will be lost.')) {
                return;
            }

            data = {
                assessmentType: '',
                activityName: '',
                date: '',
                assessor: '',
                typeSpecific: {},
                personRisks: [],
                environmentRisks: [],
                activityRisks: [],
                comments: '',
                allergies: [],
                medications: [],
                actions: [],
                activities: {}
            };
            currentStep = 0;
            isDraft = false;
            hasUnsavedChanges = false;

            document.getElementById('draftStatus').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            
            buildSteps();
            renderStep();
            updateProgress();
        }

        function nextStep() {
            if (currentStep === 0 && !data.assessmentType) {
                alert('Please select a risk assessment type.');
                return;
            }

            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep();
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges && currentStep > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Save draft before leaving?';
                return e.returnValue;
            }
        });

        initializeApp();
    
// Inserted form functions
function renderPreBookingForm() {
            const d = data.typeSpecific;
            const specialistTeachers = [
                { email: 'kfox@kingswood.bath.sch.uk', name: 'K Fox' },
                { email: 'plortal@kingswood.bath.sch.uk', name: 'P Lortal' },
                { email: 'dmurphy@kingswood.bath.sch.uk', name: 'D Murphy' },
                { email: 'ishrubsole@kingswood.bath.sch.uk', name: 'I Shrubsole' },
                { email: 'nrobinson@kingswood.bath.sch.uk', name: 'N Robinson' },
                { email: 'ezukert@kingswood.bath.sch.uk', name: 'E Zukert' },
                { email: 'fharvey@kingswood.bath.sch.uk', name: 'F Harvey' },
                { email: 'hwebb@kingswood.bath.sch.uk', name: 'H Webb' },
                { email: 'mkeighley@kingswood.bath.sch.uk', name: 'M Keighley' }
            ];
            return `
                <div class="info-box">
                    <h3>Pre-Booking Trip Approval</h3>
                    <p>Complete this form at least 1 term before the trip. This allows for improved calendar management.</p>
                </div>
                <div class="form-group">
                    <label>Purpose of Trip *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Set out a clear rationale for the trip</p>
                    <textarea id="ts_purpose" rows="4" placeholder="Describe the educational purpose and benefits of this trip...">${d.purpose || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Date of Trip *</label>
                    <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                        <p style="font-size: 13px; color: #92400e; margin: 4px 0;">  ‚ö†Ô∏è   <strong>Important:</strong></p>
                        <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #92400e;">
                            <li>Y3/4 - trips on Mondays require 2 terms notice</li>
                            <li>Y5/6 - trips on Wednesdays require 2 terms notice</li>
                            <li>Trips should generally avoid impacting Thursday after-school activities</li>
                        </ul>
                    </div>
                    <input type="date" id="ts_tripDate" value="${d.tripDate || ''}">
                </div>
                <div class="form-group">
                    <label>Alternate Suitable Dates</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Please provide alternative dates in case the preferred date is not available</p>
                    <textarea id="ts_alternateDates" rows="3" placeholder="e.g., Monday 15th March, Wednesday 24th March, or any Monday in March">${d.alternateDates || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Trip Timings (approx.) *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Approximate departure and return times</p>
                    <input type="text" id="ts_tripTimings" value="${d.tripTimings || ''}" placeholder="e.g., Depart 9:00 AM, Return 3:30 PM">
                </div>
                <div class="form-group">
                    <label>Pupils: Year/Group and Number Attending *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Specify which year group(s) and approximately how many pupils</p>
                    <input type="text" id="ts_pupils" value="${d.pupils || ''}" placeholder="e.g., Year 5 - 28 pupils">
                </div>
                <div class="form-group">
                    <label>Staff: Who and Number Attending *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">List staff members and total number</p>
                    <textarea id="ts_staffAttending" rows="3" placeholder="e.g., Mrs Smith, Mr Jones, Miss Brown - 3 staff members">${d.staffAttending || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Specialist Teachers Whose Lessons Will Be Affected *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">On approval, this form will alert the specialist teachers marked below of your trip approval.</p>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 12px;">
                        ${specialistTeachers.map(teacher => `
                            <div class="checkbox-group" style="margin-bottom: 10px;">
                                <input type="checkbox" id="ts_teacher_${teacher.email}" ${(d.affectedTeachers || []).includes(teacher.email) ? 'checked' : ''} data-teacher-email="${teacher.email}">
                                <label for="ts_teacher_${teacher.email}">${teacher.name} (${teacher.email})</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSchoolTripForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>School Trip / Off-site Visit Details</h3>
                    <p>Please provide all logistical information for this trip.</p>
                </div>
                <div class="form-group">
                    <label>Destination/Location (Include Address) *</label>
                    <input type="text" id="ts_destination" value="${d.destination || ''}" placeholder="e.g., Science Museum, Exhibition Road, South Kensington, London SW7 2DD">
                </div>
                <div class="form-group">
                    <label>Mode of Transport, Provider and Contact Details *</label>
                    <textarea id="ts_transport" rows="3" placeholder="e.g., Coach provided by ABC Travel, Contact: John Smith, Tel: 01234 567890">${d.transport || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Outbound Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_outboundDepartureTime" value="${d.outboundDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_outboundReturnTime" value="${d.outboundReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Return Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_returnDepartureTime" value="${d.returnDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_returnReturnTime" value="${d.returnReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Staff-to-Student Ratio *</label>
                    <input type="text" id="ts_ratio" value="${d.ratio || ''}" placeholder="e.g., 1:10">
                </div>
                <div class="form-group">
                    <label>Staff Members (Names, Contact Details and First Aid Qualified) *</label>
                    <textarea id="ts_staffNames" rows="5" placeholder="e.g., Mrs Sarah Smith - 07123 456789 - First Aid Qualified&#10;Mr John Jones - 07987 654321 - Not First Aid Qualified">${d.staffNames || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Students (Names) *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">You can either type the names below or upload a file</p>
                    <textarea id="ts_studentNames" rows="5" placeholder="List all students attending (one per line)&#10;e.g.,&#10;Emma Thompson&#10;James Wilson&#10;Sarah Brown">${d.studentNames || ''}</textarea>
                    <div style="margin-top: 12px;">
                        <label class="btn-secondary" style="display: inline-block; cursor: pointer; padding: 8px 16px; font-size: 13px;">
                            üìé   Upload Student List File (Optional)
                            <input type="file" id="ts_studentFile" accept=".txt,.csv,.doc,.docx" style="display: none;" onchange="handleStudentFileUpload(event)">
                        </label>
                        <span id="studentFileName" style="margin-left: 10px; font-size: 13px; color: #6b7280;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ts_medicalAck" ${d.medicalAck ? 'checked' : ''}>
                        <label for="ts_medicalAck">I acknowledge that I will take all medical information held by the school and ensure that all staff are aware of pupil conditions *</label>
                    </div>
                </div>
            `;
        }

        function renderOnsiteEventForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>On-site Event Details</h3>
                    <p>Please provide information about this on-site event.</p>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Expected Number of Visitors *</label>
                        <input type="number" id="ts_visitors" value="${d.visitors || ''}" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Expected Total Number of People *</label>
                        <input type="number" id="ts_totalPeople" value="${d.totalPeople || ''}" placeholder="e.g., 100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Venue/Rooms Being Used *</label>
                    <input type="text" id="ts_venue" value="${d.venue || ''}" placeholder="e.g., Main Hall, Classrooms 1-3">
                </div>
                <div class="form-group">
                    <label>Type of Event *</label>
                    <input type="text" id="ts_eventType" value="${d.eventType || ''}" placeholder="e.g., Sports Day, School Performance, Open Evening">
                </div>
                <div class="form-group">
                    <label>Parking Arrangements *</label>
                    <textarea id="ts_parking" rows="2" placeholder="Describe parking arrangements for visitors">${d.parking || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Timings of Event *</label>
                    <input type="text" id="ts_timings" value="${d.timings || ''}" placeholder="e.g., 2:00 PM - 5:00 PM">
                </div>
            `;
        }

        function renderCurriculumActivityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Curriculum Activity Details</h3>
                    <p>Describe the activity that requires assessment beyond normal classroom curriculum.</p>
                </div>
                <div class="form-group">
                    <label>What activity is taking place beyond the expected classroom curriculum that requires additional assessment? *</label>
                    <textarea id="ts_activityDescription" rows="5" placeholder="Describe the activity in detail...">${d.activityDescription || ''}</textarea>
                </div>
            `;
        }

        function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

function renderSchoolTripForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>School Trip / Off-site Visit Details</h3>
                    <p>Please provide all logistical information for this trip.</p>
                </div>
                <div class="form-group">
                    <label>Destination/Location (Include Address) *</label>
                    <input type="text" id="ts_destination" value="${d.destination || ''}" placeholder="e.g., Science Museum, Exhibition Road, South Kensington, London SW7 2DD">
                </div>
                <div class="form-group">
                    <label>Mode of Transport, Provider and Contact Details *</label>
                    <textarea id="ts_transport" rows="3" placeholder="e.g., Coach provided by ABC Travel, Contact: John Smith, Tel: 01234 567890">${d.transport || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Outbound Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_outboundDepartureTime" value="${d.outboundDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_outboundReturnTime" value="${d.outboundReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Return Journey *</label>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="ts_returnDepartureTime" value="${d.returnDepartureTime || ''}">
                        </div>
                        <div class="form-group">
                            <label>Return Time</label>
                            <input type="time" id="ts_returnReturnTime" value="${d.returnReturnTime || ''}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Staff-to-Student Ratio *</label>
                    <input type="text" id="ts_ratio" value="${d.ratio || ''}" placeholder="e.g., 1:10">
                </div>
                <div class="form-group">
                    <label>Staff Members (Names, Contact Details and First Aid Qualified) *</label>
                    <textarea id="ts_staffNames" rows="5" placeholder="e.g., Mrs Sarah Smith - 07123 456789 - First Aid Qualified&#10;Mr John Jones - 07987 654321 - Not First Aid Qualified">${d.staffNames || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Students (Names) *</label>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">You can either type the names below or upload a file</p>
                    <textarea id="ts_studentNames" rows="5" placeholder="List all students attending (one per line)&#10;e.g.,&#10;Emma Thompson&#10;James Wilson&#10;Sarah Brown">${d.studentNames || ''}</textarea>
                    <div style="margin-top: 12px;">
                        <label class="btn-secondary" style="display: inline-block; cursor: pointer; padding: 8px 16px; font-size: 13px;">
                            üìé   Upload Student List File (Optional)
                            <input type="file" id="ts_studentFile" accept=".txt,.csv,.doc,.docx" style="display: none;" onchange="handleStudentFileUpload(event)">
                        </label>
                        <span id="studentFileName" style="margin-left: 10px; font-size: 13px; color: #6b7280;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ts_medicalAck" ${d.medicalAck ? 'checked' : ''}>
                        <label for="ts_medicalAck">I acknowledge that I will take all medical information held by the school and ensure that all staff are aware of pupil conditions *</label>
                    </div>
                </div>
            `;
        }

        function renderOnsiteEventForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>On-site Event Details</h3>
                    <p>Please provide information about this on-site event.</p>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Expected Number of Visitors *</label>
                        <input type="number" id="ts_visitors" value="${d.visitors || ''}" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Expected Total Number of People *</label>
                        <input type="number" id="ts_totalPeople" value="${d.totalPeople || ''}" placeholder="e.g., 100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Venue/Rooms Being Used *</label>
                    <input type="text" id="ts_venue" value="${d.venue || ''}" placeholder="e.g., Main Hall, Classrooms 1-3">
                </div>
                <div class="form-group">
                    <label>Type of Event *</label>
                    <input type="text" id="ts_eventType" value="${d.eventType || ''}" placeholder="e.g., Sports Day, School Performance, Open Evening">
                </div>
                <div class="form-group">
                    <label>Parking Arrangements *</label>
                    <textarea id="ts_parking" rows="2" placeholder="Describe parking arrangements for visitors">${d.parking || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Timings of Event *</label>
                    <input type="text" id="ts_timings" value="${d.timings || ''}" placeholder="e.g., 2:00 PM - 5:00 PM">
                </div>
            `;
        }

        function renderCurriculumActivityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Curriculum Activity Details</h3>
                    <p>Describe the activity that requires assessment beyond normal classroom curriculum.</p>
                </div>
                <div class="form-group">
                    <label>What activity is taking place beyond the expected classroom curriculum that requires additional assessment? *</label>
                    <textarea id="ts_activityDescription" rows="5" placeholder="Describe the activity in detail...">${d.activityDescription || ''}</textarea>
                </div>
            `;
        }

        function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

function renderOnsiteEventForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>On-site Event Details</h3>
                    <p>Please provide information about this on-site event.</p>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Expected Number of Visitors *</label>
                        <input type="number" id="ts_visitors" value="${d.visitors || ''}" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Expected Total Number of People *</label>
                        <input type="number" id="ts_totalPeople" value="${d.totalPeople || ''}" placeholder="e.g., 100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Venue/Rooms Being Used *</label>
                    <input type="text" id="ts_venue" value="${d.venue || ''}" placeholder="e.g., Main Hall, Classrooms 1-3">
                </div>
                <div class="form-group">
                    <label>Type of Event *</label>
                    <input type="text" id="ts_eventType" value="${d.eventType || ''}" placeholder="e.g., Sports Day, School Performance, Open Evening">
                </div>
                <div class="form-group">
                    <label>Parking Arrangements *</label>
                    <textarea id="ts_parking" rows="2" placeholder="Describe parking arrangements for visitors">${d.parking || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Timings of Event *</label>
                    <input type="text" id="ts_timings" value="${d.timings || ''}" placeholder="e.g., 2:00 PM - 5:00 PM">
                </div>
            `;
        }

        function renderCurriculumActivityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Curriculum Activity Details</h3>
                    <p>Describe the activity that requires assessment beyond normal classroom curriculum.</p>
                </div>
                <div class="form-group">
                    <label>What activity is taking place beyond the expected classroom curriculum that requires additional assessment? *</label>
                    <textarea id="ts_activityDescription" rows="5" placeholder="Describe the activity in detail...">${d.activityDescription || ''}</textarea>
                </div>
            `;
        }

        function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

function renderCurriculumActivityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Curriculum Activity Details</h3>
                    <p>Describe the activity that requires assessment beyond normal classroom curriculum.</p>
                </div>
                <div class="form-group">
                    <label>What activity is taking place beyond the expected classroom curriculum that requires additional assessment? *</label>
                    <textarea id="ts_activityDescription" rows="5" placeholder="Describe the activity in detail...">${d.activityDescription || ''}</textarea>
                </div>
            `;
        }

        function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

function renderTemporaryDisabilityForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Temporary Disability Details</h3>
                    <p>Provide information about the injured party and their temporary disability.</p>
                </div>
                <div class="form-group">
                    <label>Name of Injured Party *</label>
                    <input type="text" id="ts_injuredName" value="${d.injuredName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Injury Sustained *</label>
                    <textarea id="ts_injury" rows="3" placeholder="Describe the injury">${d.injury || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Medical Professional *</label>
                    <textarea id="ts_medicalInfo" rows="3" placeholder="Medical professional's advice and recommendations">${d.medicalInfo || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Information from Parents *</label>
                    <textarea id="ts_parentInfo" rows="3" placeholder="Information provided by parents/guardians">${d.parentInfo || ''}</textarea>
                </div>
            `;
        }

        function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

function renderPEEPForm() {
            const d = data.typeSpecific;
            return `
                <div class="info-box">
                    <h3>Personal Emergency Evacuation Plan (PEEP)</h3>
                    <p>Complete the following information for the emergency evacuation plan.</p>
                </div>
                <div class="form-group">
                    <label>Name of Individual *</label>
                    <input type="text" id="ts_peepName" value="${d.peepName || ''}" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Nature of Disability/Condition *</label>
                    <textarea id="ts_disability" rows="3" placeholder="Describe the disability or medical condition">${d.disability || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Mobility/Assistance Requirements *</label>
                    <textarea id="ts_mobilityNeeds" rows="3" placeholder="What assistance is needed for mobility?">${d.mobilityNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Communication Needs *</label>
                    <textarea id="ts_communicationNeeds" rows="2" placeholder="Any special communication requirements?">${d.communicationNeeds || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Evacuation Procedures *</label>
                    <textarea id="ts_evacuationProcedures" rows="4" placeholder="Specific procedures for evacuating this individual">${d.evacuationProcedures || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Designated Assistance Personnel *</label>
                    <input type="text" id="ts_assistancePersonnel" value="${d.assistancePersonnel || ''}" placeholder="Names of staff members assigned to assist">
                </div>
                <div class="form-group">
                    <label>Assembly Point Arrangements *</label>
                    <textarea id="ts_assemblyPoint" rows="2" placeholder="Where will the individual assemble and any special arrangements">${d.assemblyPoint || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Equipment Required *</label>
                    <input type="text" id="ts_equipment" value="${d.equipment || ''}" placeholder="e.g., Wheelchair, evacuation chair, etc.">
                </div>
            `;
        }

        function handleStudentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                data.typeSpecific.studentFileName = file.name;
                data.typeSpecific.studentFileContent = content;
                const textarea = document.getElementById('ts_studentNames');
                if (textarea) {
                    if (!textarea.value.trim()) {
                        textarea.value = content;
                        data.typeSpecific.studentNames = content;
                    } else {
                        if (confirm('Replace existing student list with uploaded file?')) {
                            textarea.value = content;
                            data.typeSpecific.studentNames = content;
                        }
                    }
                }
                const fileNameSpan = document.getElementById('studentFileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = `‚úì ${file.name} uploaded`;
                    fileNameSpan.style.color = '#16a34a';
                }
                markUnsaved();
            };
            reader.readAsText(file);
        }

        function attachTypeSpecificListeners() {
            const inputs = document.querySelectorAll('[id^="ts_"]');
            inputs.forEach(input => {
                const fieldName = input.id.replace('ts_', '');
                if (input.dataset.teacherEmail) {
                    input.addEventListener('change', (e) => {
                        if (!data.typeSpecific.affectedTeachers) {
                            data.typeSpecific.affectedTeachers = [];
                        }
                        const email = e.target.dataset.teacherEmail;
                        if (e.target.checked) {
                            if (!data.typeSpecific.affectedTeachers.includes(email)) {
                                data.typeSpecific.affectedTeachers.push(email);
                            }
                        } else {
                            data.typeSpecific.affectedTeachers = data.typeSpecific.affectedTeachers.filter(t => t !== email);
                        }
                        markUnsaved();
                    });
                } else if (input.type === 'checkbox') {
                    input.addEventListener('change', (e) => {
                        data.typeSpecific[fieldName] = e.target.checked;
                        markUnsaved();
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        data.typeSpecific[fieldName] = e.target.value;
                        markUnsaved();
                    });
                }
            });
        }

        function renderRiskCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const risks = data[category.field];
            const content = document.getElementById('stepContent');
            let html = `
                <div class="info-box">
                    <h3>${category.title}</h3>
                    <p>${category.description}</p>
                    <p style="margin-top: 8px; font-style: italic;">${category.examples}</p>
                </div>
            `;
            if (risks.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No risks added yet for this category</p>
                        <button class="btn-primary" onclick="addRisk('${category.field}')">+ Add First Risk</button>
                    </div>
                `;
            } else {
                html += '<div class="risk-list">';
                risks.forEach((risk, index) => {
                    html += `
                        <div class="risk-card">
                            <div class="risk-header">
                                <h4>Risk #${index + 1}</h4>
                                <button class="btn-danger" onclick="deleteRisk('${category.field}', ${index})">Delete</button>
                            </div>
                            <div class="form-group">
                                <label>What are the hazards?</label>
                                <textarea rows="2" placeholder="Describe the hazards..." data-field="${category.field}" data-index="${index}" data-prop="hazard">${risk.hazard}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Who may be affected?</label>
                                <input type="text" placeholder="e.g., All students, Staff, Visitors" data-field="${category.field}" data-index="${index}" data-prop="affected" value="${risk.affected}">
                            </div>
                            <div class="form-group">
                                <label>What measures are in place? How have you implemented them?</label>
                                <textarea rows="3" placeholder="Describe measures and implementation..." data-field="${category.field}" data-index="${index}" data-prop="measures">${risk.measures}</textarea>
                            </div>
                            <div class="form-group">
                                <label>What emergency steps will be taken?</label>
                                <textarea rows="2" placeholder="Emergency response procedures..." data-field="${category.field}" data-index="${index}" data-prop="emergency">${risk.emergency}</textarea>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                    <button class="btn-dashed" onclick="addRisk('${category.field}')">+ Add Another Risk</button>
                `;
            }
            content.innerHTML = html;
            document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const field = e.target.dataset.field;
                    const index = e.target.dataset.index;
                    const prop = e.target.dataset.prop;
                    data[field][index][prop] = e.target.value;
                    markUnsaved();
                });
            });
        }

        function addRisk(field) {
            data[field].push({
                hazard: '',
                affected: '',
                measures: '',
                emergency: ''
            });
            markUnsaved();
            renderStep();
        }

        function deleteRisk(field, index) {
            if (confirm('Are you sure you want to delete this risk?')) {
                data[field].splice(index, 1);
                markUnsaved();
                renderStep();
            }
        }

        function renderComments(content) {
            content.innerHTML = `
                <div class="info-box gray">
                    <p>Add any additional comments, notes, or considerations that don't fit into the previous categories.</p>
                </div>
                <div class="form-group">
                    <label>Any Other Comments</label>
                    <textarea id="comments" rows="6" placeholder="Optional additional comments...">${data.comments}</textarea>
                </div>
            `;
            document.getElementById('comments').addEventListener('input', (e) => { data.comments = e.target.value; markUnsaved(); });
        }

        function renderAllergyStep(stepId, content) {
    const d = data.typeSpecific;
    
    switch(stepId) {
        case 'allergy_child':
            // Full child info form
            break;
        case 'allergy_info':
            // Full allergy selection form
            break;
        case 'allergy_medical':
            // Full medications form with add/delete
            break;
        case 'allergy_emergency':
            // Emergency contacts form
            break;
        case 'allergy_location':
            // Location & W3W form
            break;
        case 'allergy_staff':
            // Staff training checkboxes
            break;
        case 'allergy_activities':
            // Full 17-row activity table
            break;
        case 'allergy_actions':
            // Management actions form
            break;
    }
}

</script>
// Your existing JavaScript ends here
        
        // Service Worker Registration for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
    <!-- Home Button -->
    <button class="home-button" onclick="window.location.href='/'" title="Return to Home">
        üè†
    </button>
    
    <!-- Rest of your content -->
</html>
